<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° - Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³ÙŠÙŠØ± Ø§Ù„Ø¨ÙŠØ¯Ø§ØºÙˆØ¬ÙŠ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
</script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'cairo': ['Cairo', 'sans-serif'],
                    },
                    colors: {
                        primary: '#1e40af',
                        secondary: '#7c3aed',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Font Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Cairo', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #1e40af;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .page {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .page.hidden {
            transform: translateX(100%);
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            pointer-events: none;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            border-radius: 10px;
        }
        
        /* Mobile optimizations */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Modal backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="font-cairo">
    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="spinner mb-4"></div>
        <p class="text-gray-700 text-lg font-semibold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
        <p class="text-gray-500 text-sm mt-2" id="loadingText">ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³ØªØ§Ø°</p>
    </div>

    <!-- Login Screen -->
    <div id="loginPage" class="page min-h-screen p-6">
        <div class="max-w-md mx-auto">
            <!-- Logo & Title -->
            <div class="text-center mb-10">
                <div class="w-28 h-28 mx-auto mb-6 bg-gradient-to-br from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center shadow-xl">
                    <i class="fas fa-chalkboard-teacher text-5xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³ÙŠÙŠØ± Ø§Ù„Ø¨ÙŠØ¯Ø§ØºÙˆØ¬ÙŠ</h1>
                <p class="text-gray-600">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø³ØªØ§Ø° - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¨Ø´ÙŠØ± Ø§Ù„Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…ÙŠ</p>
            </div>
            
            <!-- Login Form -->
            <div class="card p-8 shadow-xl">
                <h2 class="text-xl font-bold text-gray-800 mb-6 pb-3 border-b">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                
                <div class="space-y-5">
                    <div>
                        <label class="block text-gray-700 mb-2 font-semibold">
                            <i class="fas fa-university ml-2 text-blue-500"></i>
                            Ø§Ù„ÙƒÙ„ÙŠØ©
                        </label>
                        <select id="facultySelect" 
                                class="w-full p-4 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100">
                            <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙ„ÙŠØ§Øª...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-2 font-semibold">
                            <i class="fas fa-envelope ml-2 text-blue-500"></i>
                            Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                        </label>
                        <input type="email" id="loginEmail" 
                               class="w-full p-4 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100"
                               placeholder="example@univ-bba.dz"
                               autocomplete="email">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-2 font-semibold">
                            <i class="fas fa-key ml-2 text-blue-500"></i>
                            ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                        </label>
                        <input type="password" id="loginPassword" 
                               class="w-full p-4 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100"
                               placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                               autocomplete="current-password">
                        <p class="text-gray-500 text-xs mt-2">
                            <i class="fas fa-info-circle ml-1"></i>
                            ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: 5155ØŒ 7344ØŒ Ø£Ùˆ 4445
                        </p>
                    </div>
                    
                    <button onclick="login()" id="loginBtn"
                            class="w-full py-4 btn-primary rounded-xl font-bold shadow-lg active:scale-95 transition-all duration-300 mt-2">
                        <i class="fas fa-sign-in-alt ml-2"></i>Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
                    </button>
                </div>
                
                <div class="mt-8 pt-6 border-t border-gray-100">
                    <div class="text-center text-gray-600 text-sm">
                        <p><i class="fas fa-headset ml-2 text-blue-500"></i> Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ: support@univ-bba.dz</p>
                        <p class="mt-1"><i class="fas fa-phone ml-2 text-blue-500"></i> Ø§Ù„Ù‡Ø§ØªÙ: 123-456-7890</p>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-8">
                <p class="text-gray-600 text-sm">Â© 2024 Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¨Ø´ÙŠØ± Ø§Ù„Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…ÙŠ - Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬</p>
                <p class="text-gray-500 text-xs mt-1">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="page hidden">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 pb-8 shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-white/10">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-xl font-bold">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø³ØªØ§Ø°</h1>
                <button onclick="showPage('profile')" class="p-2 rounded-lg hover:bg-white/10">
                    <i class="fas fa-user text-xl"></i>
                </button>
            </div>
            
            <!-- Professor Info -->
            <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 border border-white/20">
                <div class="flex items-center">
                    <div class="w-16 h-16 bg-white rounded-xl flex items-center justify-center ml-4">
                        <span id="avatarLetter" class="text-2xl font-bold text-blue-600"></span>
                    </div>
                    <div class="flex-1">
                        <h2 id="professorName" class="font-bold text-lg"></h2>
                        <p id="professorGrade" class="text-blue-100 text-sm"></p>
                        <p id="professorEmail" class="text-blue-200 text-xs mt-1"></p>
                    </div>
                    <div class="text-left">
                        <p id="facultyName" class="text-sm text-blue-100"></p>
                        <p class="text-xs text-blue-200 mt-1">
                            <i class="fas fa-calendar ml-1"></i>
                            <span id="currentDate"></span>
                        </p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Semester Selector -->
        <div class="mx-4 -mt-4 mb-6 hidden">
            <div class="card p-4 shadow-md">
                <label class="block text-gray-700 mb-2 font-semibold">
                    <i class="fas fa-calendar-alt ml-2 text-blue-500"></i>
                    Ø§Ø®ØªØ± ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„Ø³Ø¯Ø§Ø³ÙŠ)
                </label>
                <select id="semesterSelect" 
                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500"
                        onchange="onSemesterChange(this.value)">
                    <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„...</option>
                </select>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="px-4 mb-6">
            <h3 class="text-gray-700 font-bold mb-4 flex items-center">
                <i class="fas fa-chart-bar ml-2 text-blue-500"></i>
                Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
            </h3>
            <div class="grid grid-cols-2 gap-3">
                <div class="card p-4">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center ml-3">
                            <i class="fas fa-chalkboard text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-600 text-xs">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</p>
                            <h4 id="weeklyLectures" class="text-2xl font-bold text-gray-800">0</h4>
                        </div>
                    </div>
                </div>
                
                <!-- ØªØºÙŠÙŠØ± Ø§Ù„Ù†Øµ Ù…Ù† "Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…" Ø¥Ù„Ù‰ "Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…" -->
<div class="card p-4">
    <div class="flex items-center">
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center ml-3">
            <i class="fas fa-check-circle text-green-600 text-xl"></i>
        </div>
        <div>
            <p class="text-gray-600 text-xs">Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</p>
            <h4 id="todayAttendance" class="text-2xl font-bold text-gray-800">âœ“</h4>
        </div>
    </div>
</div>
            </div>
        </div>

        <!-- Main Features Grid -->
        <div class="px-4 mb-24">
            <h3 class="text-gray-700 font-bold mb-4 flex items-center">
                <i class="fas fa-th-large ml-2 text-blue-500"></i>
                Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </h3>
            <div class="grid grid-cols-2 gap-4">
                <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
                <div onclick="showPage('attendance')" 
                     class="card p-5 text-center active:scale-95 cursor-pointer border-2 border-transparent hover:border-blue-200">
                    <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-br from-green-50 to-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-fingerprint text-2xl text-green-600"></i>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-1">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨ </h3>
                    <p class="text-gray-600 text-xs">  ÙŠØ¬Ø¨ Ø§Ø¹Ù„Ø§Ù… Ø§Ù„Ø§Ø¯Ø§Ø±Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØºÙŠØ§Ø¨</p>
                </div>

                <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª -->
                <div onclick="showPage('schedule')" 
                     class="card p-5 text-center active:scale-95 cursor-pointer border-2 border-transparent hover:border-blue-200">
                    <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-calendar-alt text-2xl text-blue-600"></i>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-1">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h3>
                    <p class="text-gray-600 text-xs">Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„Ùƒ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</p>
                </div>

                <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª -->
                <div onclick="showPage('absences')" 
                     class="card p-5 text-center active:scale-95 cursor-pointer border-2 border-transparent hover:border-blue-200">
                    <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-br from-red-50 to-red-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-user-times text-2xl text-red-600"></i>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-1">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª</h3>
                    <p class="text-gray-600 text-xs">Ø³Ø¬Ù„ ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                </div>

                <!-- ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ -->
                <div onclick="showPage('preferences')" 
                     class="card p-5 text-center active:scale-95 cursor-pointer border-2 border-transparent hover:border-blue-200">
                    <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-star text-2xl text-purple-600"></i>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-1">ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³</h3>
                    <p class="text-gray-600 text-xs">Ø§Ø®ØªØ± Ù…Ù‚Ø§ÙŠÙŠØ³Ùƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©</p>
                </div>
            </div>
        </div>

        <!-- Sidebar Menu -->
        <div id="sidebar" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black bg-opacity-50" onclick="toggleSidebar()"></div>
            <div class="absolute right-0 top-0 bottom-0 w-80 bg-white shadow-2xl">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
                        <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-times text-xl text-gray-600"></i>
                        </button>
                    </div>
                    
                    <div class="flex items-center mb-4">
                        <div class="w-14 h-14 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-user-graduate text-2xl text-white"></i>
                        </div>
                        <div class="mr-3">
                            <h4 id="sidebarProfessorName" class="font-bold"></h4>
                            <p class="text-gray-600 text-sm">ğŸ‘¨â€ğŸ« Ø£Ø³ØªØ§Ø°</p>
                        </div>
                    </div>
                    <p id="sidebarFaculty" class="text-gray-600"></p>
                </div>
                
                <div class="p-4 space-y-1">
                    <button onclick="showPage('dashboard'); toggleSidebar();" 
                            class="w-full flex items-center p-3 rounded-lg hover:bg-gray-100 text-right">
                        <i class="fas fa-home text-gray-600 ml-3"></i>
                        <span>Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                    </button>
                    
                    <button onclick="showPage('attendance'); toggleSidebar();" 
                            class="w-full flex items-center p-3 rounded-lg hover:bg-gray-100 text-right">
                        <i class="fas fa-fingerprint text-gray-600 ml-3"></i>
                        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</span>
                    </button>
                    
                    <button onclick="showPage('schedule'); toggleSidebar();" 
                            class="w-full flex items-center p-3 rounded-lg hover:bg-gray-100 text-right">
                        <i class="fas fa-calendar-alt text-gray-600 ml-3"></i>
                        <span>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</span>
                    </button>
                    
                    <button onclick="showPage('absences'); toggleSidebar();" 
                            class="w-full flex items-center p-3 rounded-lg hover:bg-gray-100 text-right">
                        <i class="fas fa-user-times text-gray-600 ml-3"></i>
                        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª</span>
                    </button>
                    
                    <button onclick="showPage('preferences'); toggleSidebar();" 
                            class="w-full flex items-center p-3 rounded-lg hover:bg-gray-100 text-right">
                        <i class="fas fa-star text-gray-600 ml-3"></i>
                        <span>ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³</span>
                    </button>
                    
                    <button onclick="showPage('dayPreferences'); toggleSidebar();" 
                            class="w-full flex items-center p-3 rounded-lg hover:bg-gray-100 text-right">
                        <i class="fas fa-calendar-day text-gray-600 ml-3"></i>
                        <span>ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù…</span>
                    </button>
                    
                    <button onclick="showPage('profile'); toggleSidebar();" 
                            class="w-full flex items-center p-3 rounded-lg hover:bg-gray-100 text-right">
                        <i class="fas fa-user-cog text-gray-600 ml-3"></i>
                        <span>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
                    </button>
                    
                    <button onclick="logout()" 
                            class="w-full flex items-center p-3 rounded-lg hover:bg-red-50 text-red-600 text-right mt-4">
                        <i class="fas fa-sign-out-alt ml-3"></i>
                        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                    </button>
                </div>
                
                <div class="absolute bottom-0 left-0 right-0 p-4 border-t text-center">
                    <p class="text-gray-500 text-xs">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0.0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Page -->
    <div id="attendancePage" class="page hidden">
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-6 shadow-lg">
            <div class="flex items-center">
                <button onclick="showPage('dashboard')" class="p-2 rounded-lg hover:bg-white/10">
                    <i class="fas fa-arrow-right text-xl"></i>
                </button>
                <h2 class="text-xl font-bold mr-3">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
            </div>
        </div>
        
        <div class="p-6">
            <div id="attendanceContent">
                <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Page -->
    <div id="schedulePage" class="page hidden">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 shadow-lg">
            <div class="flex items-center">
                <button onclick="showPage('dashboard')" class="p-2 rounded-lg hover:bg-white/10">
                    <i class="fas fa-arrow-right text-xl"></i>
                </button>
                <h2 class="text-xl font-bold mr-3">ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h2>
            </div>
        </div>
        
        <div class="p-6">
            <div id="scheduleContent">
                <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    </div>

    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª Page -->
    <div id="absencesPage" class="page hidden">
        <div class="bg-gradient-to-r from-red-600 to-pink-600 text-white p-6 shadow-lg">
            <div class="flex items-center">
                <button onclick="showPage('dashboard')" class="p-2 rounded-lg hover:bg-white/10">
                    <i class="fas fa-arrow-right text-xl"></i>
                </button>
                <h2 class="text-xl font-bold mr-3">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª</h2>
            </div>
        </div>
        
        <div class="p-6">
            <div id="absencesContent">
                <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    </div>

    <!-- ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Page -->
    <div id="preferencesPage" class="page hidden">
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 shadow-lg">
            <div class="flex items-center">
                <button onclick="showPage('dashboard')" class="p-2 rounded-lg hover:bg-white/10">
                    <i class="fas fa-arrow-right text-xl"></i>
                </button>
                <h2 class="text-xl font-bold mr-3">â­ ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³</h2>
            </div>
        </div>
        
        <div class="p-6">
            <div id="preferencesContent">
                <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    </div>

    <!-- ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù… Page -->
    <div id="dayPreferencesPage" class="page hidden">
        <div class="bg-gradient-to-r from-orange-600 to-yellow-600 text-white p-6 shadow-lg">
            <div class="flex items-center">
                <button onclick="showPage('dashboard')" class="p-2 rounded-lg hover:bg-white/10">
                    <i class="fas fa-arrow-right text-xl"></i>
                </button>
                <h2 class="text-xl font-bold mr-3">ğŸ—“ï¸ ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù…</h2>
            </div>
        </div>
        
        <div class="p-6">
            <div id="dayPreferencesContent">
                <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profilePage" class="page hidden">
        <div class="bg-gradient-to-r from-gray-700 to-gray-900 text-white p-6 shadow-lg">
            <div class="flex items-center">
                <button onclick="showPage('dashboard')" class="p-2 rounded-lg hover:bg-white/10">
                    <i class="fas fa-arrow-right text-xl"></i>
                </button>
                <h2 class="text-xl font-bold mr-3">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
            </div>
        </div>
        
        <div class="p-6">
            <div class="card p-6">
                <div class="text-center mb-8">
                    <div class="w-28 h-28 mx-auto mb-4 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-user-graduate text-4xl text-white"></i>
                    </div>
                    <h3 id="profileName" class="text-2xl font-bold text-gray-800"></h3>
                    <p id="profileEmail" class="text-gray-600"></p>
                    <div class="inline-flex items-center mt-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                        <i class="fas fa-user-tie ml-1"></i>
                        <span id="profileRole">Ø£Ø³ØªØ§Ø°</span>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl">
                        <div>
                            <p class="text-gray-600 text-sm">Ø§Ù„ÙƒÙ„ÙŠØ©</p>
                            <p id="profileFaculty" class="font-semibold text-gray-800"></p>
                        </div>
                        <i class="fas fa-university text-gray-400 text-xl"></i>
                    </div>
                    
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl">
                        <div>
                            <p class="text-gray-600 text-sm">Ø§Ù„Ù‚Ø³Ù…</p>
                            <p id="profileDepartment" class="font-semibold text-gray-800"></p>
                        </div>
                        <i class="fas fa-building text-gray-400 text-xl"></i>
                    </div>
                    
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl">
                        <div>
                            <p class="text-gray-600 text-sm">Ø§Ù„Ø±ØªØ¨Ø©</p>
                            <p id="profileGrade" class="font-semibold text-gray-800"></p>
                        </div>
                        <i class="fas fa-award text-gray-400 text-xl"></i>
                    </div>
                    
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl">
                        <div>
                            <p class="text-gray-600 text-sm">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
                            <p id="profilePassword" class="font-semibold text-gray-800"></p>
                        </div>
                        <i class="fas fa-lock text-gray-400 text-xl"></i>
                    </div>
                    
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl">
                        <div>
                            <p class="text-gray-600 text-sm">Ø¢Ø®Ø± Ø­Ø¶ÙˆØ±</p>
                            <p id="profileLastAttendance" class="font-semibold text-gray-800">-</p>
                        </div>
                        <i class="fas fa-history text-gray-400 text-xl"></i>
                    </div>
                </div>
                
                <div class="mt-8 pt-6 border-t">
                    <button onclick="logout()" 
                            class="w-full py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-semibold shadow-lg transition">
                        <i class="fas fa-sign-out-alt ml-2"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Messages -->
    <div id="messageModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-backdrop absolute inset-0" onclick="hideModal()"></div>
        <div class="relative bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- JavaScript Application -->
    <script>
        // ============================================
        // Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        // ============================================
        const APP_CONFIG = {
            // Ù…Ù„Ù Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¹Ø§Ù…
            MAIN_SHEET_ID: "1bh6oUXadE386uTDAFq75UmfcdtfQTzavucpwUeLah4o",
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            SESSION: {
                professor: null,
                faculty: null,
                facultySheetId: null,
                semester: null,
                lastLogin: null
            },
            
            // Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
            CACHE: {
                faculties: {},
                professors: {},
                schedule: {},
                students: {},
                absences: {},
                attendanceRecords: {}
            },
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            SETTINGS: {
                autoLogoutMinutes: 120,
                attendanceCodeValidityMinutes: 10,
                cacheDurationMinutes: 5
            }
        };

        // ============================================
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
            updateCurrentDate();
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ§Øª
            await loadFaculties();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù„Ø³Ø© Ø³Ø§Ø¨Ù‚Ø©
            await checkPreviousSession();
            
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            setTimeout(() => {
                hideLoading();
            }, 800);
        });

        // ============================================
        // ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙØ­Ø§Øª
        // ============================================
        function showPage(pageName) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const pageElement = document.getElementById(pageName + 'Page') || document.getElementById(pageName);
            if (pageElement) {
                pageElement.classList.remove('hidden');
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
            switch(pageName) {
                case 'attendance':
                    loadAttendancePage();
                    break;
                case 'schedule':
                    loadSchedulePage();
                    break;
                case 'absences':
                    loadAbsencesPage();
                    break;
                case 'preferences':
                    loadPreferencesPage();
                    break;
                case 'dayPreferences':
                    loadDayPreferencesPage();
                    break;
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        }

        // ============================================
        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ†
        // ============================================
        async function checkPreviousSession() {
            try {
                const savedSession = localStorage.getItem('professor_session');
                if (savedSession) {
                    const session = JSON.parse(savedSession);
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (24 Ø³Ø§Ø¹Ø©)
                    if (session.timestamp && Date.now() - session.timestamp < 24 * 60 * 60 * 1000) {
                        APP_CONFIG.SESSION = session;
                        
                        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        updateDashboardInfo();
                        
                        // ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
                        await loadSemesterPages();
                        
                        // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                        showPage('dashboard');
                        return true;
                    } else {
                        // Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
                        localStorage.removeItem('professor_session');
                    }
                }
            } catch (error) {
                console.error('Error loading session:', error);
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ù„Ø³Ø© ØµØ§Ù„Ø­Ø©ØŒ Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            showPage('login');
            return false;
        }

        function saveSession() {
            APP_CONFIG.SESSION.timestamp = Date.now();
            localStorage.setItem('professor_session', JSON.stringify(APP_CONFIG.SESSION));
        }

        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ§Øª
        // ============================================
        async function loadFaculties() {
            try {
                updateLoadingText('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ§Øª...');
                
                const response = await fetch(`https://docs.google.com/spreadsheets/d/${APP_CONFIG.MAIN_SHEET_ID}/gviz/tq?tqx=out:json&sheet=users`);
                const text = await response.text();
                const json = JSON.parse(text.substring(47, text.length - 2));
                
                const uniqueFaculties = {};
                const select = document.getElementById('facultySelect');
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ©</option>';
                
                json.table.rows.forEach((row, index) => {
                    if (index === 0) return; // ØªØ®Ø·Ù‰ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
                    
                    const rowData = row.c;
                    if (rowData && rowData.length >= 6) {
                        const faculte = (rowData[3]?.v || '').trim();
                        const sheetId = (rowData[5]?.v || '').trim();
                        
                        if (faculte && sheetId && !uniqueFaculties[faculte]) {
                            uniqueFaculties[faculte] = sheetId;
                            
                            const option = document.createElement('option');
                            option.value = faculte;
                            option.textContent = faculte;
                            select.appendChild(option);
                        }
                    }
                });
                
                APP_CONFIG.CACHE.faculties = uniqueFaculties;
                
                updateLoadingText('Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„');
                
            } catch (error) {
                console.error('Error loading faculties:', error);
                showMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ§Øª', 'error');
            }
        }

        // ============================================
        // Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        // ============================================
        async function login() {
            const faculty = document.getElementById('facultySelect').value;
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            if (!faculty || !email || !password) {
                showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
                return;
            }
            
            const facultySheetId = APP_CONFIG.CACHE.faculties[faculty];
            if (!facultySheetId) {
                showMessage('Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©', 'error');
                return;
            }
            
            // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<div class="spinner mx-auto" style="width:20px;height:20px;"></div>';
            loginBtn.disabled = true;
            
            try {
                // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© Ù„Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
                const professors = await loadProfessors(facultySheetId);
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø³ØªØ§Ø°
                let foundProfessor = null;
                
                for (const professor of professors) {
                    // Ø§Ù„Ø¨Ø­Ø« Ø¨Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                    if (professor.email.toLowerCase() === email.toLowerCase()) {
                        foundProfessor = professor;
                        break;
                    }
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¨Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø§Ø³Ù… (ÙÙŠ Ø­Ø§Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯)
                    if (professor.name.includes(email) || email.includes(professor.name)) {
                        foundProfessor = professor;
                        break;
                    }
                }
                
                if (!foundProfessor) {
                    showMessage('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„ÙŠØ©', 'error');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                if (foundProfessor.password !== password) {
                    showMessage('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                }
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø° ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©
                APP_CONFIG.SESSION = {
                    professor: foundProfessor,
                    faculty: faculty,
                    facultySheetId: facultySheetId,
                    semester: null,
                    lastLogin: new Date().toISOString()
                };
                
                // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©
                saveSession();
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                updateDashboardInfo();
                
                // ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
                await loadSemesterPages();
                
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                showPage('dashboard');
                
                showMessage(`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ø£Ø³ØªØ§Ø° ${foundProfessor.name}`, 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message, 'error');
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }

        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
        // ============================================
        async function loadProfessors(sheetId) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
            const cacheKey = `professors_${sheetId}`;
            if (APP_CONFIG.CACHE.professors[cacheKey] && 
                Date.now() - APP_CONFIG.CACHE.professors[cacheKey].timestamp < APP_CONFIG.SETTINGS.cacheDurationMinutes * 60 * 1000) {
                return APP_CONFIG.CACHE.professors[cacheKey].data;
            }
            
            try {
                const response = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=profs`);
                const text = await response.text();
                const json = JSON.parse(text.substring(47, text.length - 2));
                
                const professors = [];
                
                json.table.rows.forEach((row, index) => {
                    if (index === 0) return; // ØªØ®Ø·Ù‰ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
                    
                    const rowData = row.c;
                    if (rowData && rowData.length >= 7) {
                        const professor = {
                            lastName: rowData[0]?.v || '',
                            firstName: rowData[1]?.v || '',
                            grade: rowData[2]?.v || '',
                            email: rowData[3]?.v || '',
                            name: rowData[4]?.v || '',
                            department: rowData[5]?.v || '',
                            password: rowData[7]?.v ? rowData[7].v.toString() : '',
                            attendance: rowData[8]?.v || '',
                            rowIndex: index + 2 // Ù„Ù„Ø­ÙØ¸ Ù„Ø§Ø­Ù‚Ø§Ù‹
                        };
                        professors.push(professor);
                    }
                });
                
                // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
                APP_CONFIG.CACHE.professors[cacheKey] = {
                    data: professors,
                    timestamp: Date.now()
                };
                
                return professors;
                
            } catch (error) {
                console.error('Error loading professors:', error);
                throw error;
            }
        }

        // ============================================
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        // ============================================
        function updateDashboardInfo() {
            const session = APP_CONFIG.SESSION;
            if (!session || !session.professor) return;
            
            const prof = session.professor;
            // ÙÙŠ updateDashboardInfo()
if (prof.absenceAnnouncement) {
    const absenceArray = prof.absenceAnnouncement.split(', ');
    const lastAbsence = absenceArray[absenceArray.length - 1];
    document.getElementById('profileLastAttendance').textContent = 
        lastAbsence + ' (Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨)';
} else {
    document.getElementById('profileLastAttendance').textContent = '-';
}
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø£Ø³
            document.getElementById('avatarLetter').textContent = prof.name.charAt(0);
            document.getElementById('professorName').textContent = prof.name;
            document.getElementById('professorGrade').textContent = prof.grade;
            document.getElementById('professorEmail').textContent = prof.email;
            document.getElementById('facultyName').textContent = session.faculty;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
            document.getElementById('sidebarProfessorName').textContent = prof.name;
            document.getElementById('sidebarFaculty').textContent = session.faculty;
            
            // ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            document.getElementById('profileName').textContent = prof.name;
            document.getElementById('profileEmail').textContent = prof.email;
            document.getElementById('profileFaculty').textContent = session.faculty;
            document.getElementById('profileDepartment').textContent = prof.department;
            document.getElementById('profileGrade').textContent = prof.grade;
            document.getElementById('profilePassword').textContent = prof.password;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¶ÙˆØ±
            checkTodayAttendance();
            
            // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
            loadLectureStatistics();
        }

        // ============================================
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…
        // ============================================
        function checkTodayAttendance() {
            const prof = APP_CONFIG.SESSION.professor;
            const today = new Date().toISOString().split('T')[0];
            
            const todayAttendance = document.getElementById('todayAttendance');
            
            if (prof.attendance && prof.attendance.includes(today)) {
                todayAttendance.textContent = "âœ“";
                todayAttendance.className = "text-2xl font-bold text-green-600";
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¢Ø®Ø± ÙˆÙ‚Øª Ø­Ø¶ÙˆØ±
                const attendanceArray = prof.attendance.split(', ');
                const lastAttendance = attendanceArray[attendanceArray.length - 1];
                document.getElementById('profileLastAttendance').textContent = lastAttendance;
            } else {
                todayAttendance.textContent = "âŒ";
                todayAttendance.className = "text-2xl font-bold text-red-600";
            }
        }

        // ============================================
        // ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„Ø³Ø¯Ø§Ø³ÙŠØ§Øª)
        // ============================================
        async function loadSemesterPages() {
    try {
        const sheetId = APP_CONFIG.SESSION.facultySheetId;
        const response = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=base`);
        const text = await response.text();
        const json = JSON.parse(text.substring(47, text.length - 2));
        
        const select = document.getElementById('semesterSelect');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</option>';
        
        const semesters = [];
        
        json.table.rows.forEach(row => {
            const semester = row.c[0]?.v;
            if (semester && semester.trim() !== '' && !semesters.includes(semester)) {
                semesters.push(semester);
                
                const option = document.createElement('option');
                option.value = semester;
                option.textContent = semester;
                select.appendChild(option);
            }
        });
        
        // â­â­â­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø£Ø³Ø¨Ù‚ÙŠØ© 1) Ø³Ø¯Ø§Ø³ÙŠ Ù…Ø­ÙÙˆØ¸ 2) Ø¢Ø®Ø± Ø³Ø¯Ø§Ø³ÙŠ â­â­â­
        if (APP_CONFIG.SESSION.semester && semesters.includes(APP_CONFIG.SESSION.semester)) {
            select.value = APP_CONFIG.SESSION.semester;
        } else if (semesters.length > 0) {
            // Ø¬Ø¹Ù„ Ø¢Ø®Ø± Ø³Ø¯Ø§Ø³ÙŠ Ù‡Ùˆ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
            const lastSemester = semesters[semesters.length - 1];
            select.value = lastSemester;
            APP_CONFIG.SESSION.semester = lastSemester;
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            setTimeout(() => {
                onSemesterChange(lastSemester);
            }, 100);
        }
        
    } catch (error) {
        console.error('Error loading semesters:', error);
        showMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„', 'error');
    }
}

        function onSemesterChange(semester) {
            APP_CONFIG.SESSION.semester = semester;
            saveSession();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¯Ø§Ø³ÙŠ
            loadLectureStatistics();
        }

        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
        // ============================================
        async function loadLectureStatistics() {
            try {
                const session = APP_CONFIG.SESSION;
                if (!session.semester || !session.facultySheetId) return;
                
                // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
                const schedule = await loadScheduleData(session.facultySheetId, session.semester);
                
                // Ø¹Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°
                let lectureCount = 0;
                const profName = session.professor.name;
                
                schedule.forEach(row => {
                    if (row['Ø§Ù„Ø§Ø³ØªØ§Ø°'] === profName) {
                        lectureCount++;
                    }
                });
                
                document.getElementById('weeklyLectures').textContent = lectureCount;
                
            } catch (error) {
                console.error('Error loading lecture statistics:', error);
            }
        }

        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
        // ============================================
        async function loadScheduleData(sheetId, semester) {
            const cacheKey = `schedule_${sheetId}_${semester}`;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
            if (APP_CONFIG.CACHE.schedule[cacheKey] && 
                Date.now() - APP_CONFIG.CACHE.schedule[cacheKey].timestamp < APP_CONFIG.SETTINGS.cacheDurationMinutes * 60 * 1000) {
                return APP_CONFIG.CACHE.schedule[cacheKey].data;
            }
            
            try {
                const response = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(semester)}`);
                const text = await response.text();
                const json = JSON.parse(text.substring(47, text.length - 2));
                
                const schedule = [];
                let headers = [];
                
                json.table.rows.forEach((row, index) => {
                    const rowData = row.c;
                    
                    if (index === 0) {
                        // Ø­ÙØ¸ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
                        headers = rowData.map(cell => cell?.v || '');
                    } else if (rowData) {
                        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙ Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù†
                        const rowObject = {};
                        rowData.forEach((cell, cellIndex) => {
                            const header = headers[cellIndex];
                            if (header) {
                                rowObject[header] = cell?.v || '';
                            }
                        });
                        schedule.push(rowObject);
                    }
                });
                
                // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
                APP_CONFIG.CACHE.schedule[cacheKey] = {
                    data: schedule,
                    timestamp: Date.now()
                };
                
                return schedule;
                
            } catch (error) {
                console.error('Error loading schedule:', error);
                throw error;
            }
        }

        // ============================================
        // ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
        // ============================================
        async function loadAttendancePage() {
    const content = document.getElementById('attendanceContent');
    content.innerHTML = `
        <div class="text-center py-12">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨...</p>
        </div>
    `;
    
    try {
        const session = APP_CONFIG.SESSION;
        const prof = session.professor;
        const today = new Date().toISOString().split('T')[0];
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø¯ Ø£Ø¹Ù„Ù† Ø¹Ù† ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…
        const alreadyAnnounced = prof.absenceAnnouncement && prof.absenceAnnouncement.includes(today);
        
        if (alreadyAnnounced) {
            content.innerHTML = `
                <div class="card p-6">
                    <div class="text-center py-6">
                        <div class="w-20 h-20 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-3xl text-yellow-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">âš ï¸ ØªÙ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</h3>
                        <p class="text-gray-600 mb-4">Ù„Ù‚Ø¯ Ø£Ø¹Ù„Ù†Øª Ø¹Ù† ØºÙŠØ§Ø¨Ùƒ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</p>
                        <button onclick="showPage('dashboard')" 
                                class="mt-6 px-6 py-2 btn-primary rounded-lg">
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </button>
                    </div>
                </div>
            `;
            return;
        }
        
        // Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨
        content.innerHTML = `
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“¢ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨</h3>
                
                <div class="bg-yellow-50 p-4 rounded-xl mb-6">
                    <h4 class="font-bold text-yellow-800 mb-2">ğŸ“… Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨:</h4>
                    <input type="date" id="absenceDate" 
                           value="${today}"
                           class="w-full p-3 bg-white border border-yellow-300 rounded-lg focus:outline-none focus:border-yellow-500">
                    <p class="text-yellow-700 text-xs mt-2">
                        <i class="fas fa-info-circle ml-1"></i>
                        Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø°ÙŠ Ø³ØªØªØºÙŠØ¨ ÙÙŠÙ‡ Ø¹Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
                    </p>
                </div>
                
                <div class="mb-6" id="lecturesListSection">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØªØ§Ø± Ù‡Ù†Ø§ -->
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2 font-semibold">
                        <i class="fas fa-comment ml-2"></i>
                        Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    </label>
                    <textarea id="absenceReason" 
                              class="w-full p-4 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500"
                              rows="3"
                              placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..."></textarea>
                </div>
                
                <button onclick="announceAbsence()" 
                        id="announceBtn"
                        class="w-full py-4 bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl font-bold shadow-lg transition mb-4">
                    <i class="fas fa-bell ml-2"></i>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨
                </button>
                
                <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                    <h4 class="font-bold text-red-800 mb-2 flex items-center">
                        <i class="fas fa-exclamation-triangle ml-2"></i>
                        Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø©:
                    </h4>
                    <ul class="text-red-700 text-sm space-y-2 pr-4">
                        <li>1.  ÙŠØ³ØªØ­Ø³Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨ Ù‚Ø¨Ù„ 24 Ø³Ø§Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</li>
                        <li>2. Ø³ÙŠØªÙ… Ø¥Ø®Ø·Ø§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø¹Ù†ÙŠÙŠÙ† Ø¨Ø§Ù„ØºÙŠØ§Ø¨</li>
                        <li>3. ÙŠØ¬Ø¨ ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ø­ØµØµ ÙÙŠ ÙˆÙ‚Øª Ù„Ø§Ø­Ù‚</li>
                        <li>4. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… ÙÙŠ Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ</li>
                    </ul>
                </div>
            </div>
        `;
        
        // ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯
        loadLecturesForDate(today);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
        document.getElementById('absenceDate').addEventListener('change', function(e) {
            loadLecturesForDate(e.target.value);
        });
        
    } catch (error) {
        console.error('Error loading absence announcement page:', error);
        content.innerHTML = `
            <div class="card p-6">
                <div class="text-center py-6">
                    <div class="w-20 h-20 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</h3>
                    <p class="text-gray-600 mb-4">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨</p>
                    <button onclick="loadAttendancePage()" 
                            class="px-6 py-2 btn-primary rounded-lg">
                        Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                    </button>
                </div>
            </div>
        `;
    }
}
    async function loadLecturesForDate(dateString) {
    try {
        const session = APP_CONFIG.SESSION;
        if (!session.semester || !session.facultySheetId) return;
        
        const date = new Date(dateString);
        const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        const dayName = days[date.getDay()];
        
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
        const schedule = await loadScheduleData(session.facultySheetId, session.semester);
        
        // ØªØµÙÙŠØ© Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ø£Ø³ØªØ§Ø°
        const profName = session.professor.name;
        const dayLectures = schedule.filter(row => 
            row['Ø§Ù„ÙŠÙˆÙ…'] === dayName && row['Ø§Ù„Ø§Ø³ØªØ§Ø°'] === profName
        );
        
        const lecturesSection = document.getElementById('lecturesListSection');
        if (dayLectures.length > 0) {
            let html = `
                <h4 class="font-bold text-gray-700 mb-3">Ù…Ø­Ø§Ø¶Ø±Ø§Øª ${dayName} (${formatArabicDate(dateString)}):</h4>
                <div class="space-y-2">
            `;
            
            dayLectures.forEach(lecture => {
                html += `
                    <div class="bg-gray-50 p-3 rounded-lg border">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-gray-800">${lecture['Ø§Ù„Ù…Ù‚ÙŠØ§Ø³'] || 'Ù…Ù‚ÙŠØ§Ø³'}</span>
                            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">${lecture['Ø§Ù„ØªÙˆÙ‚ÙŠØª'] || ''}</span>
                        </div>
                        <div class="text-sm text-gray-600 mt-1">
                            ${lecture['Ø§Ù„Ù‚Ø§Ø¹Ø©'] ? `Ø§Ù„Ù‚Ø§Ø¹Ø©: ${lecture['Ø§Ù„Ù‚Ø§Ø¹Ø©']}` : ''}
                            ${lecture['Ø§Ù„Ø­ØµØ©'] ? ` | Ø§Ù„ÙÙˆØ¬: ${lecture['Ø§Ù„Ø­ØµØ©']}` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                <p class="text-gray-500 text-sm mt-2">
                    <i class="fas fa-info-circle ml-1"></i>
                    Ø³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨ØºÙŠØ§Ø¨Ùƒ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
                </p>
            `;
            lecturesSection.innerHTML = html;
        } else {
            lecturesSection.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-bold text-blue-800 mb-2">ğŸ“… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®</h4>
                    <p class="text-blue-700">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…Ø¬Ø¯ÙˆÙ„Ø© ÙÙŠ ${formatArabicDate(dateString)}</p>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading lectures for date:', error);
    }
}
function formatArabicDate(dateString) {
    const date = new Date(dateString);
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('ar-EG', options);
}


async function announceAbsence() {
    const dateInput = document.getElementById('absenceDate');
    const reasonInput = document.getElementById('absenceReason');
    const announceBtn = document.getElementById('announceBtn');
    
    const selectedDate = dateInput.value;
    const reason = reasonInput.value.trim();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„
    if (!selectedDate) {
        showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨', 'error');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙ‚Ø· Ù…Ù† Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ÙŠØ³ ÙÙŠ Ø§Ù„Ù…Ø§Ø¶ÙŠ
    const today = new Date();
    const selected = new Date(selectedDate);
    selected.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    
    if (selected < today) {
        showMessage('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨ Ù„ØªØ§Ø±ÙŠØ® Ù…Ø§Ø¶ÙŠ', 'error');
        return;
    }
    
    // ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
    const originalText = announceBtn.innerHTML;
    announceBtn.innerHTML = '<div class="spinner" style="width:20px;height:20px;display:inline-block;margin-left:8px;"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù…...';
    announceBtn.disabled = true;
    
    try {
        const session = APP_CONFIG.SESSION;
        const prof = session.professor;
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
        const response = await fetch('https://bba1.vercel.app/saveProfessorAbsence', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sheetId: session.facultySheetId,
                professorName: prof.name,
                professorEmail: prof.email,
                absenceDate: selectedDate,
                reason: reason,
                faculty: session.faculty
            })
        });
        
        if (!response.ok) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            if (!prof.absenceAnnouncement) prof.absenceAnnouncement = '';
            prof.absenceAnnouncement = prof.absenceAnnouncement ? 
                prof.absenceAnnouncement + ', ' + selectedDate : 
                selectedDate;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©
            session.professor = prof;
            APP_CONFIG.SESSION = session;
            saveSession();
            
            // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            showSuccessAnnouncement(prof.name, selectedDate, result.message);
            showMessage('âœ… ØªÙ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            
        } else {
            showMessage('âŒ ' + (result.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨'), 'error');
        }
        
    } catch (error) {
        console.error('Error announcing absence:', error);
        showMessage('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'error');
    } finally {
        announceBtn.innerHTML = originalText;
        announceBtn.disabled = false;
    }
}
function showSuccessAnnouncement(professorName, absenceDate, message) {
    const content = document.getElementById('attendanceContent');
    const arabicDate = formatArabicDate(absenceDate);
    
    content.innerHTML = `
        <div class="card p-6">
            <div class="text-center py-6">
                <div class="w-24 h-24 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-bell text-4xl text-yellow-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">ğŸ“¢ ØªÙ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨</h3>
                <p class="text-gray-600 mb-2">Ø§Ù„Ø£Ø³ØªØ§Ø°: <span class="font-bold">${professorName}</span></p>
                <p class="text-gray-600 mb-2">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨: <span class="font-bold">${arabicDate}</span></p>
                ${message ? `<p class="text-green-600 mb-4">${message}</p>` : ''}
                
                <div class="bg-green-50 p-4 rounded-lg mt-4 mb-6">
                    <h4 class="font-bold text-green-800 mb-2">âœ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©:</h4>
                    <ul class="text-green-700 text-sm space-y-1 pr-4">
                        <li>â€¢ ØªÙ… Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø§Ù„ØºÙŠØ§Ø¨</li>
                        <li>â€¢ Ø³ÙŠØªÙ… Ø¥Ø®Ø·Ø§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨</li>
                        <li>â€¢ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨ ÙÙŠ Ø³Ø¬Ù„Ùƒ</li>
                        <li>â€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</li>
                    </ul>
                </div>
                
                <button onclick="showPage('dashboard')" 
                        class="w-full py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600">
                    <i class="fas fa-home ml-2"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </button>
            </div>
        </div>
    `;
}
function checkTodayAttendance() {
    const prof = APP_CONFIG.SESSION.professor;
    const today = new Date().toISOString().split('T')[0];
    
    const todayAttendance = document.getElementById('todayAttendance');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø³ØªØ§Ø° Ù‚Ø¯ Ø£Ø¹Ù„Ù† Ø¹Ù† ØºÙŠØ§Ø¨Ù‡ Ø§Ù„ÙŠÙˆÙ…
    if (prof.absenceAnnouncement && prof.absenceAnnouncement.includes(today)) {
        todayAttendance.textContent = "âš ï¸";
        todayAttendance.className = "text-2xl font-bold text-yellow-600";
        todayAttendance.title = "ØªÙ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø¨Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…";
    } else {
        // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡
        todayAttendance.textContent = "âœ“";
        todayAttendance.className = "text-2xl font-bold text-green-600";
        todayAttendance.title = "Ø­Ø§Ø¶Ø±";
    }
}
       
// ============================================
// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
// ============================================
async function testServerConnection() {
    try {
        showMessage('ğŸ”Œ Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…...', 'info');
        
        const response = await fetch('http://bba1.vercel.app/health', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            throw new Error(`Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('âœ… Ø§ØªØµØ§Ù„ Ø§Ù„Ø®Ø§Ø¯Ù…:', data);
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ù…ØµØ§Ø¯Ù‚Ø© Google Sheets
        const authTest = await fetch('http://bba1.vercel.app/testProfessorAuth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sheetId: APP_CONFIG.SESSION.facultySheetId
            })
        });
        
        const authData = await authTest.json();
        console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', authData);
        
        if (authData.status === 'success') {
            showMessage(`âœ… Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ - ${authData.professorsCount} Ø£Ø³ØªØ§Ø° ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©`, 'success');
        } else {
            showMessage(`âš ï¸ ${authData.message}`, 'warning');
        }
        
    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„:', error);
        showMessage('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ server.js', 'error');
    }
}

// ============================================
// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø¬Ø§Ø­
// ============================================
function showSuccessScreen(professorName, attendanceTime) {
    const content = document.getElementById('attendanceContent');
    const localTime = new Date(attendanceTime.replace(' ', 'T')).toLocaleString('ar-SA');
    
    content.innerHTML = `
        <div class="card p-6">
            <div class="text-center py-6">
                <div class="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-check text-4xl text-white"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">ğŸ‰ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±!</h3>
                <p class="text-gray-600 mb-2">Ø§Ù„Ø£Ø³ØªØ§Ø°: <span class="font-bold">${professorName}</span></p>
                <p class="text-gray-600 mb-6">â° ${localTime}</p>
                
                <button onclick="showPage('dashboard')" 
                        class="w-full py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600">
                    <i class="fas fa-home ml-2"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </button>
            </div>
        </div>
    `;
}

        // ============================================
        // ØµÙØ­Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
        // ============================================
        async function loadSchedulePage() {
            const content = document.getElementById('scheduleContent');
            content.innerHTML = `
                <div class="text-center py-12">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª...</p>
                </div>
            `;
            
            try {
                const session = APP_CONFIG.SESSION;
                if (!session.semester) {
                    content.innerHTML = `
                        <div class="card p-6">
                            <div class="text-center py-6">
                                <div class="w-20 h-20 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-3xl text-yellow-600"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">Ø§Ø®ØªØ± ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</h3>
                                <p class="text-gray-600 mb-4">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ</p>
                                <button onclick="showPage('dashboard')" 
                                        class="px-6 py-2 btn-primary rounded-lg">
                                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
                const schedule = await loadScheduleData(session.facultySheetId, session.semester);
                const profName = session.professor.name;
                
                // ØªØµÙÙŠØ© Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°
                const profSchedule = schedule.filter(row => row['Ø§Ù„Ø§Ø³ØªØ§Ø°'] === profName);
                
                if (profSchedule.length === 0) {
                    content.innerHTML = `
                        <div class="card p-6">
                            <div class="text-center py-6">
                                <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-calendar-times text-3xl text-gray-600"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h3>
                                <p class="text-gray-600 mb-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ùƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¯Ø§Ø³ÙŠ</p>
                                <button onclick="showPage('dashboard')" 
                                        class="px-6 py-2 btn-primary rounded-lg">
                                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…
                const daysOrder = ['Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³'];
                const scheduleByDay = {};
                
                daysOrder.forEach(day => {
                    scheduleByDay[day] = profSchedule.filter(row => row['Ø§Ù„ÙŠÙˆÙ…'] === day);
                });
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                let html = `
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª - ${session.semester}</h3>
                            <button onclick="downloadSchedule()" 
                                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm">
                                <i class="fas fa-download ml-1"></i>ØªØ­Ù…ÙŠÙ„
                            </button>
                        </div>
                        
                        <div class="mb-6 grid grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-blue-600 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</p>
                                <p class="text-2xl font-bold text-blue-800">${profSchedule.length}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <p class="text-green-600 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</p>
                                <p class="text-2xl font-bold text-green-800">${Object.keys(scheduleByDay).filter(day => scheduleByDay[day].length > 0).length}</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="text-purple-600 text-sm">Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³</p>
                                <p class="text-2xl font-bold text-purple-800">${new Set(profSchedule.map(row => row['Ø§Ù„Ù…Ù‚ÙŠØ§Ø³'])).size}</p>
                            </div>
                        </div>
                `;
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù„ÙƒÙ„ ÙŠÙˆÙ…
                daysOrder.forEach(day => {
                    const dayLectures = scheduleByDay[day];
                    if (dayLectures.length > 0) {
                        html += `
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-700 mb-3 p-3 bg-gray-50 rounded-lg">${day}</h4>
                                <div class="space-y-3">
                        `;
                        
                        dayLectures.sort((a, b) => {
                            const timeA = a['Ø§Ù„ØªÙˆÙ‚ÙŠØª'] || '';
                            const timeB = b['Ø§Ù„ØªÙˆÙ‚ÙŠØª'] || '';
                            return timeA.localeCompare(timeB);
                        }).forEach(lecture => {
                            html += `
                                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-bold text-gray-800">${lecture['Ø§Ù„Ù…Ù‚ÙŠØ§Ø³'] || 'Ù…Ù‚ÙŠØ§Ø³'}</span>
                                        <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">${lecture['Ø§Ù„ØªÙˆÙ‚ÙŠØª'] || ''}</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                                        ${lecture['Ø§Ù„Ù‚Ø³Ù…'] ? `<div><span class="font-medium">Ø§Ù„Ù‚Ø³Ù…:</span> ${lecture['Ø§Ù„Ù‚Ø³Ù…']}</div>` : ''}
                                        ${lecture['Ø§Ù„ØªØ®ØµØµ'] ? `<div><span class="font-medium">Ø§Ù„ØªØ®ØµØµ:</span> ${lecture['Ø§Ù„ØªØ®ØµØµ']}</div>` : ''}
                                        ${lecture['Ø§Ù„Ø­ØµØ©'] ? `<div><span class="font-medium">Ø§Ù„Ø­ØµØ©:</span> ${lecture['Ø§Ù„Ø­ØµØ©']}</div>` : ''}
                                        ${lecture['Ø§Ù„Ù‚Ø§Ø¹Ø©'] ? `<div><span class="font-medium">Ø§Ù„Ù‚Ø§Ø¹Ø©:</span> ${lecture['Ø§Ù„Ù‚Ø§Ø¹Ø©']}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += `
                        <div class="mt-8 pt-6 border-t">
                            <button onclick="showPage('dashboard')" 
                                    class="w-full py-3 btn-primary rounded-lg">
                                <i class="fas fa-arrow-right ml-2"></i>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                            </button>
                        </div>
                    </div>
                `;
                
                content.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading schedule page:', error);
                content.innerHTML = `
                    <div class="card p-6">
                        <div class="text-center py-6">
                            <div class="w-20 h-20 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</h3>
                            <p class="text-gray-600 mb-4">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</p>
                            <button onclick="loadSchedulePage()" 
                                    class="px-6 py-2 btn-primary rounded-lg">
                                Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function downloadSchedule() {
            // Ù‡Ø°Ù‡ ÙˆØ¸ÙŠÙØ© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒÙ…Ù„Ù CSV
            showMessage('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info');
        }

        // ============================================
// ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
// ============================================
async function loadAbsencesPage() {
    const content = document.getElementById('absencesContent');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    content.innerHTML = `
        <div class="card p-6">
            <div class="text-center py-12">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª...</p>
            </div>
        </div>
    `;
    
    try {
        const session = APP_CONFIG.SESSION;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¯Ø§Ø³ÙŠ Ù…Ø­Ø¯Ø¯
        if (!session.semester) {
            content.innerHTML = `
                <div class="card p-6">
                    <div class="text-center py-6">
                        <div class="w-20 h-20 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-3xl text-yellow-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Ø§Ø®ØªØ± ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</h3>
                        <p class="text-gray-600 mb-4">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø£ÙˆÙ„Ø§Ù‹</p>
                        <button onclick="showPage('dashboard')" 
                                class="px-6 py-2 btn-primary rounded-lg">
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </button>
                    </div>
                </div>
            `;
            return;
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°
        const schedule = await loadScheduleData(session.facultySheetId, session.semester);
        const profName = session.professor.name;
        
        // ØªØµÙÙŠØ© Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°
        const profSchedule = schedule.filter(row => row['Ø§Ù„Ø§Ø³ØªØ§Ø°'] === profName);
        
        if (profSchedule.length === 0) {
            content.innerHTML = `
                <div class="card p-6">
                    <div class="text-center py-6">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-calendar-times text-3xl text-gray-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h3>
                        <p class="text-gray-600 mb-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ùƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¯Ø§Ø³ÙŠ</p>
                        <button onclick="showPage('dashboard')" 
                                class="px-6 py-2 btn-primary rounded-lg">
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </button>
                    </div>
                </div>
            `;
            return;
        }
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ®ØµØµØ§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
        const uniqueSpecialties = [...new Set(profSchedule.map(row => row['Ø§Ù„ØªØ®ØµØµ']).filter(Boolean))];
        
        if (uniqueSpecialties.length === 0) {
            content.innerHTML = `
                <div class="card p-6">
                    <div class="text-center py-6">
                        <div class="w-20 h-20 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-3xl text-yellow-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ®ØµØµØ§Øª</h3>
                        <p class="text-gray-600 mb-4">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„Ùƒ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªØ®ØµØµØ§Øª Ù…Ø­Ø¯Ø¯Ø©</p>
                        <button onclick="showPage('dashboard')" 
                                class="px-6 py-2 btn-primary rounded-lg">
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </button>
                    </div>
                </div>
            `;
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª Ù…Ø¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        content.innerHTML = `
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸ“ ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                <p class="text-gray-600">Ø³Ø¬Ù„ ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ</p>
            </div>
            
            <div class="card p-6 mb-6">
                <div class="tabs flex overflow-x-auto border-b mb-6">
                    <button onclick="showAbsenceTab('record')" 
                            id="tabRecord" 
                            class="tab-btn flex-1 py-3 px-4 font-semibold text-gray-700 border-b-2 border-blue-500">
                        <i class="fas fa-edit ml-2"></i>ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨ Ø¬Ø¯ÙŠØ¯
                    </button>
                    <button onclick="showAbsenceTab('view')" 
                            id="tabView" 
                            class="tab-btn flex-1 py-3 px-4 font-semibold text-gray-500 hover:text-gray-700">
                        <i class="fas fa-list ml-2"></i>Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª
                    </button>
                    <button onclick="showAbsenceTab('stats')" 
                            id="tabStats" 
                            class="tab-btn flex-1 py-3 px-4 font-semibold text-gray-500 hover:text-gray-700">
                        <i class="fas fa-chart-bar ml-2"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨
                    </button>
                </div>
                
                <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
                <div id="absenceTabContent">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
            </div>
        `;
        
        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù„Ø§Ø­Ù‚
        ABSENCES_DATA = {
            schedule: profSchedule,
            specialties: uniqueSpecialties,
            selectedSpecialty: null,
            selectedCourse: null,
            selectedGroup: null,
            selectedDate: new Date().toISOString().split('T')[0],
            studentsData: null
        };
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        showAbsenceTab('record');
        
    } catch (error) {
        console.error('Error loading absences page:', error);
        content.innerHTML = `
            <div class="card p-6">
                <div class="text-center py-6">
                    <div class="w-20 h-20 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</h3>
                    <p class="text-gray-600 mb-4">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª</p>
                    <button onclick="loadAbsencesPage()" 
                            class="px-6 py-2 btn-primary rounded-lg">
                        Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                    </button>
                </div>
            </div>
        `;
    }
}

// Ù…ØªØºÙŠØ±Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª
let ABSENCES_DATA = {
    schedule: [],
    specialties: [],
    selectedSpecialty: null,
    selectedCourse: null,
    selectedGroup: null,
    selectedDate: null,
    studentsData: null,
    currentAbsences: {}
};

// ============================================
// Ø¥Ø¯Ø§Ø±Ø© ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª
// ============================================
function showAbsenceTab(tabName) {
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-gray-700');
        btn.classList.add('text-gray-500');
    });
    
    const activeBtn = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
    if (activeBtn) {
        activeBtn.classList.add('border-blue-500', 'text-gray-700');
        activeBtn.classList.remove('text-gray-500');
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    const tabContent = document.getElementById('absenceTabContent');
    
    switch(tabName) {
        case 'record':
            loadRecordAbsenceTab();
            break;
        case 'view':
            loadViewAbsencesTab();
            break;
        case 'stats':
            loadAbsenceStatsTab();
            break;
    }
}

// ============================================
// ØªØ¨ÙˆÙŠØ¨ ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨ Ø¬Ø¯ÙŠØ¯
// ============================================
function loadRecordAbsenceTab() {
    const tabContent = document.getElementById('absenceTabContent');
    
    tabContent.innerHTML = `
        <div class="space-y-6">
            <div>
                <h4 class="font-bold text-gray-700 mb-4">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</h4>
                
                <!-- Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ®ØµØµ -->
                <div class="mb-4">
                    <label class="block text-gray-600 mb-2">Ø§Ù„ØªØ®ØµØµ</label>
                    <select id="absenceSpecialty" 
                            onchange="onAbsenceSpecialtyChange(this.value)"
                            class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØ®ØµØµ</option>
                        ${ABSENCES_DATA.specialties.map(spec => 
                            `<option value="${spec}">${spec}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <!-- Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ®ØµØµ) -->
                <div id="courseSection" class="hidden mb-4">
                    <label class="block text-gray-600 mb-2">Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</label>
                    <select id="absenceCourse" 
                            onchange="onAbsenceCourseChange(this.value)"
                            class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</option>
                    </select>
                </div>
                
                <!-- Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙÙˆØ¬ (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³) -->
                <div id="groupSection" class="hidden mb-4">
                    <label class="block text-gray-600 mb-2">Ø§Ù„ÙÙˆØ¬</label>
                    <select id="absenceGroup" 
                            onchange="onAbsenceGroupChange(this.value)"
                            class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙÙˆØ¬</option>
                    </select>
                </div>
                
                <!-- Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® -->
                <div class="mb-6">
                    <label class="block text-gray-600 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</label>
                    <input type="date" id="absenceDate" 
                           value="${ABSENCES_DATA.selectedDate}"
                           onchange="onAbsenceDateChange(this.value)"
                           class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <!-- Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
                <div id="loadStudentsSection" class="hidden">
                    <button onclick="loadStudentsForAbsence()" 
                            id="loadStudentsBtn"
                            class="w-full py-3 btn-primary rounded-lg font-semibold">
                        <i class="fas fa-users ml-2"></i>ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                    </button>
                </div>
            </div>
            
            <!-- Ù‚Ø³Ù… Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ -->
            <div id="studentsListSection" class="hidden">
                <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù‡Ù†Ø§ -->
            </div>
        </div>
    `;
}

// ============================================
// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„ØªØ®ØµØµ
// ============================================
function onAbsenceSpecialtyChange(specialty) {
    ABSENCES_DATA.selectedSpecialty = specialty;
    ABSENCES_DATA.selectedCourse = null;
    ABSENCES_DATA.selectedGroup = null;
    
    if (!specialty) {
        document.getElementById('courseSection').classList.add('hidden');
        document.getElementById('groupSection').classList.add('hidden');
        document.getElementById('loadStudentsSection').classList.add('hidden');
        return;
    }
    
    // ØªØµÙÙŠØ© Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø­Ø³Ø¨ Ø§Ù„ØªØ®ØµØµ
    const courses = ABSENCES_DATA.schedule
        .filter(row => row['Ø§Ù„ØªØ®ØµØµ'] === specialty)
        .map(row => row['Ø§Ù„Ù…Ù‚ÙŠØ§Ø³'])
        .filter((value, index, self) => self.indexOf(value) === index);
    
    const courseSelect = document.getElementById('absenceCourse');
    courseSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</option>';
    courses.forEach(course => {
        const option = document.createElement('option');
        option.value = course;
        option.textContent = course;
        courseSelect.appendChild(option);
    });
    
    document.getElementById('courseSection').classList.remove('hidden');
    document.getElementById('groupSection').classList.add('hidden');
    document.getElementById('loadStudentsSection').classList.add('hidden');
}

// ============================================
// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³
// ============================================
function onAbsenceCourseChange(course) {
    ABSENCES_DATA.selectedCourse = course;
    ABSENCES_DATA.selectedGroup = null;
    
    if (!course) {
        document.getElementById('groupSection').classList.add('hidden');
        document.getElementById('loadStudentsSection').classList.add('hidden');
        return;
    }
    
    // ØªØµÙÙŠØ© Ø§Ù„ÙÙˆØ¬ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³
    const groups = ABSENCES_DATA.schedule
        .filter(row => row['Ø§Ù„Ù…Ù‚ÙŠØ§Ø³'] === course)
        .map(row => row['Ø§Ù„Ø­ØµØ©'])
        .filter(group => group && group.trim() !== '')
        .filter((value, index, self) => self.indexOf(value) === index);
    
    const groupSelect = document.getElementById('absenceGroup');
    groupSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙÙˆØ¬</option>';
    groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        groupSelect.appendChild(option);
    });
    
    document.getElementById('groupSection').classList.remove('hidden');
    document.getElementById('loadStudentsSection').classList.add('hidden');
}

// ============================================
// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„ÙÙˆØ¬
// ============================================
function onAbsenceGroupChange(group) {
    ABSENCES_DATA.selectedGroup = group;
    
    if (group) {
        document.getElementById('loadStudentsSection').classList.remove('hidden');
    } else {
        document.getElementById('loadStudentsSection').classList.add('hidden');
    }
}

// ============================================
// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
// ============================================
function onAbsenceDateChange(date) {
    ABSENCES_DATA.selectedDate = date;
}


// ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ ØªØ´Ø®ÙŠØµ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
// ============================================
async function loadStudentsForAbsence() {
    const loadBtn = document.getElementById('loadStudentsBtn');
    const originalText = loadBtn.innerHTML;
    
    try {
        loadBtn.innerHTML = '<div class="spinner mx-auto" style="width:20px;height:20px;"></div>';
        loadBtn.disabled = true;
        
        const session = APP_CONFIG.SESSION;
        
        console.log('=== Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ ===');
        console.log('Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ù…Ø­Ø¯Ø¯:', ABSENCES_DATA.selectedSpecialty);
        console.log('Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ù…Ø­Ø¯Ø¯:', ABSENCES_DATA.selectedCourse);
        console.log('Ø§Ù„ÙÙˆØ¬ Ø§Ù„Ù…Ø­Ø¯Ø¯:', ABSENCES_DATA.selectedGroup);
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ø­Ø§Ø¶Ø±Ø©
        const selectedLecture = ABSENCES_DATA.schedule.find(row => 
            row['Ø§Ù„ØªØ®ØµØµ'] === ABSENCES_DATA.selectedSpecialty &&
            row['Ø§Ù„Ù…Ù‚ÙŠØ§Ø³'] === ABSENCES_DATA.selectedCourse &&
            row['Ø§Ù„Ø­ØµØ©'] === ABSENCES_DATA.selectedGroup
        );
        
        console.log('Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:', selectedLecture);
        
        if (!selectedLecture) {
            showMessage('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©', 'error');
            return;
        }
        
        if (!selectedLecture['Ø§Ù„Ù‚Ø³Ù…']) {
            showMessage('âŒ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…', 'error');
            console.error('Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ù‚Ø³Ù…:', selectedLecture);
            return;
        }
        
        const department = selectedLecture['Ø§Ù„Ù‚Ø³Ù…'];
        console.log('Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬:', department);
        console.log('Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù„Ù:', session.facultySheetId);
        
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù‚Ø³Ù…
        const students = await loadDepartmentStudents(session.facultySheetId, department);
        
        console.log('Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ù…Ù„ÙˆÙ†:', students);
        console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨:', students.length);
        
        if (students.length === 0) {
            showMessage(`âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‚Ø³Ù… "${department}"`, 'error');
            console.error(`âš ï¸ Ù‚Ø³Ù… "${department}" Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ù„ÙØŒ Ø£Ùˆ Ù‚Ø¯ ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹`);
            console.error(`ğŸ”— ÙŠÙ…ÙƒÙ†Ùƒ ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·: https://docs.google.com/spreadsheets/d/${session.facultySheetId}/edit#gid=0 Ù„Ù„ØªØ­Ù‚Ù‚`);
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        console.log('Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨:', Object.keys(students[0] || {}));
        
        // ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ®ØµØµ ÙˆØ§Ù„ÙÙˆØ¬
        const filteredStudents = students.filter(student => {
            const studentSpecialty = student['Ø§Ù„ØªØ®ØµØµ'] || student['ØªØ®ØµØµ'] || student['specialty'];
            const studentGroup = student['Ø§Ù„Ø­ØµØ©'] || student['ÙÙˆØ¬'] || student['group'];
            
            console.log(`Ø·Ø§Ù„Ø¨: ${student['Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨'] || student['Ø§Ø³Ù…']} | ØªØ®ØµØµ: ${studentSpecialty} | ÙÙˆØ¬: ${studentGroup}`);
            
            return studentSpecialty === ABSENCES_DATA.selectedSpecialty &&
                   studentGroup === ABSENCES_DATA.selectedGroup;
        });
        
        console.log('Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙÙŠØ©:', filteredStudents);
        console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙÙŠØ©:', filteredStudents.length);
        
        if (filteredStudents.length === 0) {
            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            const errorDetails = `
                <div class="bg-red-50 p-4 rounded-lg mt-4 text-right">
                    <h6 class="font-bold text-red-800 mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:</h6>
                    <ul class="text-sm text-red-700 space-y-1">
                        <li>â€¢ Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <strong>${ABSENCES_DATA.selectedSpecialty}</strong></li>
                        <li>â€¢ Ø§Ù„ÙÙˆØ¬ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <strong>${ABSENCES_DATA.selectedGroup}</strong></li>
                        <li>â€¢ Ø§Ù„Ù‚Ø³Ù…: <strong>${department}</strong></li>
                        <li>â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong>${students.length}</strong></li>
                        <li>â€¢ Ø§Ù„ØªØ®ØµØµØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: <strong>${[...new Set(students.map(s => s['Ø§Ù„ØªØ®ØµØµ'] || s['ØªØ®ØµØµ']))].join(', ')}</strong></li>
                        <li>â€¢ Ø§Ù„Ø£ÙÙˆØ¬ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: <strong>${[...new Set(students.map(s => s['Ø§Ù„Ø­ØµØ©'] || s['ÙÙˆØ¬']))].join(', ')}</strong></li>
                    </ul>
                </div>
            `;
            
            showModal(`
                <h3 class="text-xl font-bold text-gray-800 mb-4">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</h3>
                <p class="text-gray-600 mb-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„ØªØ®ØµØµ <strong>${ABSENCES_DATA.selectedSpecialty}</strong> ÙˆØ§Ù„ÙÙˆØ¬ <strong>${ABSENCES_DATA.selectedGroup}</strong></p>
                ${errorDetails}
                <div class="mt-6 flex space-x-3 space-x-reverse">
                    <button onclick="hideModal()" class="flex-1 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Ø¥ØºÙ„Ø§Ù‚
                    </button>
                    <button onclick="testSheetConnection('${session.facultySheetId}', '${department}')" 
                            class="flex-1 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        <i class="fas fa-bug ml-2"></i>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                    </button>
                </div>
            `);
            return;
        }
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
        ABSENCES_DATA.studentsData = {
            department: department,
            students: filteredStudents,
            absences: {}
        };
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
filteredStudents.forEach(student => {
    const studentId = student['Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„']; // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­
    if (!ABSENCES_DATA.studentsData.absences[studentId]) {
        ABSENCES_DATA.studentsData.absences[studentId] = { absences: [] };
    }
});
        
        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', filteredStudents.length, 'Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø·Ù„Ø§Ø¨
        await loadExistingAbsences(filteredStudents);
        
        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
        displayStudentsForAbsence(filteredStudents);
        
        showMessage(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${filteredStudents.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨:', error);
        
        showModal(`
            <h3 class="text-xl font-bold text-gray-800 mb-4">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</h3>
            <p class="text-gray-600 mb-4">${error.message}</p>
            <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                <h6 class="font-bold text-yellow-800 mb-2">Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</h6>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>1. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙØ­Ø© Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„Ù…Ù„Ù</li>
                    <li>2. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ø§Ø¨Ù‚ Ø¨Ø§Ù„Ø¶Ø¨Ø·)</li>
                    <li>3. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù‚Ø³Ù…</li>
                    <li>4. ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù„Ù</li>
                </ul>
            </div>
            <div class="flex space-x-3 space-x-reverse">
                <button onclick="hideModal()" class="flex-1 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
                <button onclick="loadAbsencesPage()" class="flex-1 py-3 btn-primary rounded-lg">
                    Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                </button>
            </div>
        `);
    } finally {
        loadBtn.innerHTML = originalText;
        loadBtn.disabled = false;
    }
}

// ============================================
// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ù„Ù
// ============================================
async function testSheetConnection(sheetId, department) {
    try {
        showModal(`
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</h3>
            <div class="text-center py-6">
                <div class="spinner mx-auto mb-4"></div>
                <p>Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ù„Ù...</p>
            </div>
        `);
        
        const testUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(department)}`;
        console.log('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·:', testUrl);
        
        const response = await fetch(testUrl);
        const text = await response.text();
        
        if (text.includes('error')) {
            throw new Error('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡');
        }
        
        const json = JSON.parse(text.substring(47, text.length - 2));
        
        hideModal();
        
        showModal(`
            <h3 class="text-xl font-bold text-gray-800 mb-4">âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­</h3>
            <div class="bg-green-50 p-4 rounded-lg mb-4">
                <h6 class="font-bold text-green-800 mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ù:</h6>
                <ul class="text-sm text-green-700 space-y-1">
                    <li>â€¢ Ø§Ù„Ù…Ù„Ù: ${sheetId}</li>
                    <li>â€¢ Ø§Ù„ØµÙØ­Ø©: ${department}</li>
                    <li>â€¢ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${json.table.rows.length}</li>
                    <li>â€¢ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ${json.table.cols ? json.table.cols.length : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</li>
                </ul>
            </div>
            <div class="mt-4">
                <h6 class="font-bold text-gray-700 mb-2">Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</h6>
                <div class="bg-gray-50 p-3 rounded text-sm overflow-auto max-h-40">
                    <pre>${JSON.stringify(json.table.rows.slice(0, 3), null, 2)}</pre>
                </div>
            </div>
            <button onclick="hideModal()" class="w-full mt-6 py-3 btn-primary rounded-lg">
                ÙÙ‡Ù…Øª
            </button>
        `);
        
    } catch (error) {
        hideModal();
        
        showModal(`
            <h3 class="text-xl font-bold text-gray-800 mb-4">âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</h3>
            <p class="text-gray-600 mb-4">${error.message}</p>
            <div class="bg-red-50 p-4 rounded-lg mb-4">
                <h6 class="font-bold text-red-800 mb-2">Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:</h6>
                <ul class="text-sm text-red-700 space-y-1">
                    <li>â€¢ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù…Ø­Ø°ÙˆÙ</li>
                    <li>â€¢ Ø§Ù„ØµÙØ­Ø© "${department}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</li>
                    <li>â€¢ Ø§Ù„Ù…Ù„Ù Ø®Ø§Øµ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡</li>
                    <li>â€¢ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</li>
                </ul>
            </div>
            <div class="mt-4">
                <a href="https://docs.google.com/spreadsheets/d/${sheetId}/edit" 
                   target="_blank"
                   class="block w-full py-3 bg-blue-500 hover:bg-blue-600 text-white text-center rounded-lg font-semibold">
                    <i class="fas fa-external-link-alt ml-2"></i>ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯
                </a>
            </div>
            <button onclick="hideModal()" class="w-full mt-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                Ø¥ØºÙ„Ø§Ù‚
            </button>
        `);
    }
}

// ============================================
// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ø¹ ØªØ´Ø®ÙŠØµ Ù…Ø­Ø³Ù†
// ============================================
async function loadDepartmentStudents(sheetId, department) {
    const cacheKey = `students_${sheetId}_${department}`;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
    if (APP_CONFIG.CACHE.students[cacheKey] && 
        Date.now() - APP_CONFIG.CACHE.students[cacheKey].timestamp < APP_CONFIG.SETTINGS.cacheDurationMinutes * 60 * 1000) {
        console.log(`âœ… ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù‚Ø³Ù…: "${department}"`);
        return APP_CONFIG.CACHE.students[cacheKey].data;
    }
    
    try {
        console.log(`ğŸ“¥ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ù‚Ø³Ù…: "${department}"`);
        
        // 1. Ø¨Ù†Ø§Ø¡ Ø±Ø§Ø¨Ø· API
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(department)}`;
        console.log('ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·:', url);
        
        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${response.status} ${response.statusText}`);
        }
        
        const text = await response.text();
        console.log('ğŸ“„ Ø·ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', text.length, 'Ø­Ø±Ù');
        
        // 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ JSON ÙÙ‚Ø·
        let jsonText;
        if (text.startsWith('/*O_o*/')) {
            const startIndex = text.indexOf('{');
            const endIndex = text.lastIndexOf('}') + 1;
            if (startIndex === -1 || endIndex === -1) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ JSON ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©');
            jsonText = text.substring(startIndex, endIndex);
        } else {
            jsonText = text.trim();
            const lastBraceIndex = jsonText.lastIndexOf('}');
            if (lastBraceIndex !== -1) jsonText = jsonText.substring(0, lastBraceIndex + 1);
        }
        
        console.log('ğŸ” JSON Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ (Ø§Ù„Ù€ 500 Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„Ù‰):', jsonText.substring(0, 500));
        
        // 4. ØªØ­Ù„ÙŠÙ„ JSON
        let json;
        try {
            json = JSON.parse(jsonText);
        } catch (parseError) {
            console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ JSONØŒ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ');
            const cleanJsonText = jsonText
                .replace(/,\s*]/g, ']')
                .replace(/,\s*}/g, '}')
                .replace(/'/g, '"')
                .replace(/\\/g, '\\\\')
                .replace(/\r?\n|\r/g, '')
                .trim();
            json = JSON.parse(cleanJsonText);
        }
        
        if (!json.table || !json.table.rows) throw new Error('Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­');
        console.log(`âœ… JSON Ù…Ø­Ù„Ù„ Ø¨Ù†Ø¬Ø§Ø­ØŒ ${json.table.rows.length} ØµÙ`);
        
        // 5. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„ØµØ­ÙŠØ­Ø©
        const headers = ["Ø§Ù„Ù‚Ø³Ù…", "Ø§Ù„ØªØ®ØµØµ", "Ø§Ù„Ø­ØµØ©", "Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨", "Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„", "Ø§Ù„ØºÙŠØ§Ø¨"];
        const students = [];

        json.table.rows.forEach((row, index) => {
            const rowData = row.c || [];
            if (rowData.length > 0) {
                const student = {};
                headers.forEach((header, i) => {
                    const value = (rowData[i]?.v?.toString() || '').trim();
                    student[header] = value;
                });
                students.push(student);
            }
        });
        
        console.log(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${students.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Ù‚Ø³Ù… "${department}"`);
        
        // 6. Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
        APP_CONFIG.CACHE.students[cacheKey] = {
            data: students,
            timestamp: Date.now()
        };
        
        return students;
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨:', error);
        showModal(`
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ” Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <div class="bg-red-50 p-4 rounded-lg mb-4">
                <p class="text-red-700 mb-2"><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${error.message}</p>
                <p class="text-red-700 text-sm mb-2">Ø§Ù„Ù‚Ø³Ù…: ${department}</p>
                <p class="text-red-700 text-sm">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù„Ù: ${sheetId}</p>
            </div>
            
            <div class="mb-4">
                <h6 class="font-bold text-gray-700 mb-2">Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</h6>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li>1. ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙØ­Ø© <strong>"${department}"</strong> Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù</li>
                    <li>2. Ø§ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙˆØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø©</li>
                    <li>3. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                </ul>
            </div>
            
            <div class="flex space-x-3 space-x-reverse">
                <button onclick="hideModal()" class="flex-1 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">Ø¥ØºÙ„Ø§Ù‚</button>
                <a href="https://docs.google.com/spreadsheets/d/${sheetId}/edit#gid=0" 
                   target="_blank"
                   class="flex-1 py-3 bg-blue-500 hover:bg-blue-600 text-white text-center rounded-lg font-semibold">
                    <i class="fas fa-external-link-alt ml-2"></i>ÙØªØ­ Ø§Ù„Ù…Ù„Ù
                </a>
            </div>
        `);
        
        throw error;
    }
}

// ============================================
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨
// ============================================
async function loadExistingAbsences(students) {
    try {
        const selectedCourse = ABSENCES_DATA.selectedCourse;
        const selectedDate = ABSENCES_DATA.selectedDate;
        
        // âš¡ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† currentAbsences Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (!ABSENCES_DATA.currentAbsences) {
            ABSENCES_DATA.currentAbsences = {};
        }
        
        students.forEach(student => {
            const studentId = student['Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„'];
            
            if (!studentId) {
                console.warn('âš ï¸ Ø·Ø§Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… ØªØ³Ø¬ÙŠÙ„:', student);
                return;
            }
            
            try {
                const absencesJson = student['Ø§Ù„ØºÙŠØ§Ø¨'] ? JSON.parse(student['Ø§Ù„ØºÙŠØ§Ø¨']) : { absences: [] };
                const existingAbsence = absencesJson.absences.find(absence => 
                    absence.date === selectedDate && 
                    absence.module === selectedCourse
                );
                
                // âš¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙØªØ§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
                ABSENCES_DATA.currentAbsences[studentId] = existingAbsence ? true : false;
                
            } catch (error) {
                // Ø¥Ø°Ø§ Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ JSONØŒ Ø¶Ø¹ false Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø§Ù„Ø®Ø·Ø£
                ABSENCES_DATA.currentAbsences[studentId] = false;
            }
        });
        
    } catch (error) {
        console.error('Error loading existing absences:', error);
    }
}

// ============================================
// Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
// ============================================
function displayStudentsForAbsence(students) {
    const section = document.getElementById('studentsListSection');
    
    let html = `
        <div class="border-t pt-6">
            <h4 class="font-bold text-gray-700 mb-4">
                <i class="fas fa-users ml-2"></i>
                Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (${students.length} Ø·Ø§Ù„Ø¨)
            </h4>
            
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-blue-600 text-sm">Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</p>
                        <p class="font-bold text-blue-800">${ABSENCES_DATA.selectedCourse}</p>
                    </div>
                    <div>
                        <p class="text-blue-600 text-sm">Ø§Ù„ØªØ§Ø±ÙŠØ®</p>
                        <p class="font-bold text-blue-800">${formatDate(ABSENCES_DATA.selectedDate)}</p>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="p-3 text-right text-gray-600 font-semibold">#</th>
                            <th class="p-3 text-right text-gray-600 font-semibold">Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                            <th class="p-3 text-right text-gray-600 font-semibold">Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨</th>
                            <th class="p-3 text-right text-gray-600 font-semibold">ØºÙŠØ§Ø¨</th>
                            <th class="p-3 text-right text-gray-600 font-semibold">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</th> <!-- â­ Ø¬Ø¯ÙŠØ¯ -->
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
    `;
    
    students.forEach((student, index) => {
        const studentId = student['Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„'];
        const isAbsent = ABSENCES_DATA.currentAbsences[studentId] || false;
        const participation = ABSENCES_DATA.currentParticipations?.[studentId] || 0; // â­ Ø¬Ø¯ÙŠØ¯
        
        html += `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-3">${index + 1}</td>
                <td class="p-3 font-mono">${studentId}</td>
                <td class="p-3">${student['Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨']}</td>
                <td class="p-3">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" 
                               id="absence_${studentId}"
                               ${isAbsent ? 'checked' : ''}
                               onchange="updateStudentAbsence('${studentId}', this.checked)"
                               class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                        <span class="mr-2 text-gray-700">ØºÙŠØ§Ø¨</span>
                    </label>
                </td>
                <td class="p-3"> <!-- â­ Ø¬Ø¯ÙŠØ¯ -->
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <select id="participation_${studentId}"
                                onchange="updateStudentParticipation('${studentId}', this.value)"
                                class="w-24 px-3 py-1 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="0" ${participation === 0 ? 'selected' : ''}>0 - Ù„Ù… ÙŠØ´Ø§Ø±Ùƒ</option>
                            <option value="1" ${participation === 1 ? 'selected' : ''}>1 - Ø¶Ø¹ÙŠÙ</option>
                            <option value="2" ${participation === 2 ? 'selected' : ''}>2 - Ù…ØªÙˆØ³Ø·</option>
                            <option value="3" ${participation === 3 ? 'selected' : ''}>3 - Ù†Ø´ÙŠØ·</option>
                        </select>
                        <span class="text-sm text-gray-500">/3</span>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <div class="mt-6 flex space-x-3 space-x-reverse">
                <button onclick="saveAbsences()" 
                        id="saveAbsencesBtn"
                        class="flex-1 py-3 btn-success rounded-lg font-semibold">
                    <i class="fas fa-save ml-2"></i>Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª
                </button>
                <button onclick="clearAbsencesSelection()" 
                        class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50">
                    <i class="fas fa-times ml-2"></i>Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
                </button>
            </div>
        </div>
    `;
    
    section.innerHTML = html;
    section.classList.remove('hidden');
}
// â­ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© â­
function updateStudentParticipation(studentId, value) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨ÙŠÙ† 0-3
    const participationValue = Math.min(3, Math.max(0, parseInt(value) || 0));
    
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ§Ø¦Ù†
    if (!ABSENCES_DATA.currentParticipations) {
        ABSENCES_DATA.currentParticipations = {};
    }
    
    ABSENCES_DATA.currentParticipations[studentId] = participationValue;
    
    console.log(`ğŸ“ ØªØ­Ø¯ÙŠØ« Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨ ${studentId}: ${participationValue}`);
}
// ============================================
// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨
// ============================================
function updateStudentAbsence(studentId, isAbsent) {
    ABSENCES_DATA.currentAbsences[studentId] = isAbsent;
}

// ============================================
// Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª
// ============================================
async function saveAbsences() {
     // â­â­â­ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ù‚Ù‚ Ø£ÙˆÙ„Ø§Ù‹ â­â­â­
    if (!ABSENCES_DATA || !ABSENCES_DATA.studentsData || !ABSENCES_DATA.studentsData.students) {
        showMessage('âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨" Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
    }
    
    if (!ABSENCES_DATA.selectedDate || !ABSENCES_DATA.selectedCourse) {
        showMessage('âŒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ù‚ÙŠØ§Ø³ Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
    }
    const saveBtn = document.getElementById('saveAbsencesBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<div class="spinner"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    saveBtn.disabled = true;

    try {
        const department = ABSENCES_DATA.studentsData.department;
        const sheetId = APP_CONFIG.SESSION.facultySheetId;
        const selectedDate = ABSENCES_DATA.selectedDate;
        const selectedCourse = ABSENCES_DATA.selectedCourse;

        // â­â­ ØªÙ‡ÙŠØ¦Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ© â­â­
        if (!ABSENCES_DATA.currentAbsences) ABSENCES_DATA.currentAbsences = {};
        if (!ABSENCES_DATA.currentParticipations) ABSENCES_DATA.currentParticipations = {};

        const absencesData = ABSENCES_DATA.studentsData.students.map(student => ({
            studentId: student['Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„'],
            isAbsent: ABSENCES_DATA.currentAbsences[student['Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„']] || false, // âœ… Ø§Ù„Ø¢Ù† ØªØ¹Ù…Ù„
            participation: ABSENCES_DATA.currentParticipations[student['Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„']] || 0,
            date: selectedDate,
            module: selectedCourse
        }));

        // â­â­ Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· HTTPS â­â­
        const response = await fetch('https://bba1.vercel.app/saveAbsences', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                sheetId, 
                department, 
                absencesData,
                method: 'BATCH'  // â­ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
            })
        });

        const result = await response.json();
        
        // â­â­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ â­â­
        console.log('ğŸ“¨ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:', result);

if(result.success === true || result.status === 'success' || result.status === 'success'){
    const message = result.message || `ØªÙ… ØªØ­Ø¯ÙŠØ« ${result.updated || result.processed} Ø·Ø§Ù„Ø¨`;
    showMessage(`âœ… ${message}`, 'success');
} else {
    const message = result.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸';
    showMessage(`âŒ ${message}`, 'error');
}

    } catch(error){
        console.error('Error:', error);
        showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message, 'error');
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}
// Ø¯Ø§Ù„Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
async function tryBackupSave() {
    try {
        console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...');
        
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        const response = await fetch('http://bba1.vercel.app/saveAbsencesBatch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyData)
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            showMessage('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ (Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©)', 'success');
        }
    } catch (backupError) {
        console.error('Backup save failed:', backupError);
    }
}

// ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function optimizeUIForLargeData() {
    // Virtual scrolling Ù„Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø·ÙˆÙŠÙ„Ø©
    // Debounce Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    // Lazy loading Ù„Ù„ØµÙˆØ±
}


// ============================================
// Ù…Ø³Ø­ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨
// ============================================
function clearAbsencesSelection() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    Object.keys(ABSENCES_DATA.currentAbsences).forEach(key => {
        ABSENCES_DATA.currentAbsences[key] = false;
    });
}

// ============================================
// ØªØ¨ÙˆÙŠØ¨ Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª
// ============================================
async function loadViewAbsencesTab() {
    const tabContent = document.getElementById('absenceTabContent');
    
    tabContent.innerHTML = `
        <div class="space-y-6">
            <div>
                <h4 class="font-bold text-gray-700 mb-4">Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª</h4>
                
                <div class="mb-4">
                    <label class="block text-gray-600 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</label>
                    <select id="viewCourseSelect" 
                            onchange="onViewCourseChange(this.value)"
                            class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</option>
                        ${getUniqueCourses().map(course => 
                            `<option value="${course}">${course}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div id="viewAbsencesContent" class="mt-6">
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-search text-3xl mb-3"></i>
                        <p>Ø§Ø®ØªØ± Ù…Ù‚ÙŠØ§Ø³Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}
// ============================================
// ØªØ¨ÙˆÙŠØ¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨
// ============================================
function loadAbsenceStatsTab() {
    const tabContent = document.getElementById('absenceTabContent');
    
    tabContent.innerHTML = `
        <div class="space-y-6">
            <div>
                <h4 class="font-bold text-gray-700 mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨</h4>
                
                <div class="mb-4">
                    <label class="block text-gray-600 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</label>
                    <select id="statsCourseSelect" 
                            onchange="onStatsCourseChange(this.value)"
                            class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</option>
                        ${getUniqueCourses().map(course => 
                            `<option value="${course}">${course}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div id="statsContent" class="mt-6">
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-chart-bar text-3xl mb-3"></i>
                        <p>Ø§Ø®ØªØ± Ù…Ù‚ÙŠØ§Ø³Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ============================================
// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø©
// ============================================
async function onStatsCourseChange(course) {
    if (!course) return;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙÙˆØ¬ Ø£ÙˆÙ„Ø§Ù‹
    const groups = getGroupsForCourse(course);
    
    if (groups.length === 0) {
        showMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙÙˆØ§Ø¬ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³', 'error');
        return;
    }
    
    if (groups.length === 1) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙˆØ¬ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
        await loadStatsForCourseAndGroup(course, groups[0]);
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ø¯Ø© Ø£ÙÙˆØ§Ø¬ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙÙˆØ¬
        showGroupSelectionForStats(course, groups);
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙÙˆØ§Ø¬ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³
function getGroupsForCourse(course) {
    if (!ABSENCES_DATA || !ABSENCES_DATA.schedule) return [];
    
    return ABSENCES_DATA.schedule
        .filter(row => row['Ø§Ù„Ù…Ù‚ÙŠØ§Ø³'] === course)
        .map(row => row['Ø§Ù„Ø­ØµØ©'])
        .filter(group => group && group.trim() !== '')
        .filter((value, index, self) => self.indexOf(value) === index)
        .sort();
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙÙˆØ¬
function showGroupSelectionForStats(course, groups) {
    const content = document.getElementById('statsContent');
    
    content.innerHTML = `
        <div>
            <h5 class="font-bold text-gray-700 mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - ${course}</h5>
            
            <div class="card p-6 mb-4">
                <h6 class="font-bold text-gray-700 mb-4">Ø§Ø®ØªØ± Ø§Ù„ÙÙˆØ¬:</h6>
                <div class="grid grid-cols-2 gap-3">
                    ${groups.map(group => `
                        <button onclick="loadStatsForCourseAndGroup('${course}', '${group}')"
                                class="p-4 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg text-center transition">
                            <i class="fas fa-users text-blue-600 text-xl mb-2"></i>
                            <p class="font-bold text-blue-800">${group}</p>
                            <p class="text-blue-600 text-sm">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
                        </button>
                    `).join('')}
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
                <p class="text-gray-600 text-sm">
                    <i class="fas fa-info-circle ml-1"></i>
                    Ø§Ø®ØªØ± Ø§Ù„ÙÙˆØ¬ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
                </p>
            </div>
        </div>
    `;
}

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ù…Ø¹ Ø§Ù„ÙÙˆØ¬)
async function loadStatsForCourseAndGroup(course, group) {
    const content = document.getElementById('statsContent');
    content.innerHTML = `
        <div class="text-center py-6">
            <div class="spinner mx-auto mb-4"></div>
            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${course} - ${group}...</p>
        </div>
    `;
    
    try {
        const session = APP_CONFIG.SESSION;
        
        if (!session || !session.facultySheetId) {
            throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù„Ù„Ø¬Ø¯ÙˆÙ„');
        }
        
        // â­â­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù…Ø© group â­â­
        const result = await fetchCourseAbsencesDirect(
            session.facultySheetId,
            session.department || 'Ø§Ù„Ù‚Ø³Ù…',
            course,
            group  // â­ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙˆØ¬ Ù‡Ù†Ø§
        );
        
        if (result.status !== 'success') {
            throw new Error(result.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
        
        const absencesData = result.absences || [];
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„ÙÙˆØ¬
        const filteredData = absencesData.filter(item => {
            // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙˆØ¬ Ø§Ù„Ù…Ø­Ø¯Ø¯
            return item.group === group || !item.group; // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† group
        });
        
        const totalAbsences = filteredData.filter(a => a.status === 'ØºØ§Ø¦Ø¨').length;
        const totalParticipations = filteredData.filter(a => a.participation).length;
        const uniqueStudents = [...new Set(filteredData.map(a => a.studentId))].length;
        
        // Ø­Ø³Ø§Ø¨ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
        const participationScores = filteredData
            .filter(a => a.participation)
            .map(a => a.participation);
        
        const participationStats = {
            score1: participationScores.filter(s => s === 1).length,
            score2: participationScores.filter(s => s === 2).length,
            score3: participationScores.filter(s => s === 3).length
        };
        
        // Ø­Ø³Ø§Ø¨ ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª
        const absenceDays = [...new Set(filteredData
            .filter(a => a.status === 'ØºØ§Ø¦Ø¨')
            .map(a => a.date))];
        
        content.innerHTML = `
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h5 class="font-bold text-gray-700">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - ${course}</h5>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                            <i class="fas fa-users ml-1"></i> ${group}
                        </span>
                        <button onclick="showGroupSelectionForStats('${course}', ${JSON.stringify(getGroupsForCourse(course))})"
                                class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-sm">
                            <i class="fas fa-exchange-alt ml-1"></i>ØªØºÙŠÙŠØ± Ø§Ù„ÙÙˆØ¬
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-blue-600 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                        <p class="text-2xl font-bold text-blue-800">${uniqueStudents}</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <p class="text-red-600 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª</p>
                        <p class="text-2xl font-bold text-red-800">${totalAbsences}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-green-600 text-sm">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</p>
                        <p class="text-2xl font-bold text-green-800">${totalParticipations}</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-purple-600 text-sm">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</p>
                        <p class="text-2xl font-bold text-purple-800">
                            ${participationScores.length > 0 ? 
                                (participationScores.reduce((a, b) => a + b, 0) / participationScores.length).toFixed(1) : 
                                '0.0'}/3
                        </p>
                    </div>
                </div>
                
                ${totalParticipations > 0 ? `
                <div class="bg-white border rounded-lg p-4 mb-4">
                    <h6 class="font-bold text-gray-700 mb-3">
                        <i class="fas fa-chart-pie ml-2"></i>
                        ØªÙˆØ²ÙŠØ¹ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
                    </h6>
                    <div class="space-y-3">
                        ${[
                            {score: 3, label: 'Ù†Ø´ÙŠØ·', color: 'bg-green-500', count: participationStats.score3},
                            {score: 2, label: 'Ù…ØªÙˆØ³Ø·', color: 'bg-blue-500', count: participationStats.score2},
                            {score: 1, label: 'Ø¶Ø¹ÙŠÙ', color: 'bg-yellow-500', count: participationStats.score1}
                        ].map(item => {
                            const percentage = totalParticipations > 0 ? 
                                Math.round((item.count / totalParticipations) * 100) : 0;
                            return `
                                <div class="flex items-center">
                                    <div class="w-24 text-sm text-gray-600">${item.label} (${item.score}/3)</div>
                                    <div class="flex-1 ml-4">
                                        <div class="h-6 bg-gray-200 rounded overflow-hidden">
                                            <div class="h-full ${item.color} transition-all duration-500" 
                                                 style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                    <div class="w-16 text-right text-sm font-medium">${item.count} (${percentage}%)</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${totalAbsences > 0 ? `
                <div class="bg-white border rounded-lg p-4 mb-4">
                    <h6 class="font-bold text-gray-700 mb-3">
                        <i class="fas fa-calendar-times ml-2"></i>
                        Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨
                    </h6>
                    <div class="space-y-2">
                        ${absenceDays.map(day => {
                            const dayAbsences = filteredData.filter(a => 
                                a.status === 'ØºØ§Ø¦Ø¨' && a.date === day
                            ).length;
                            return `
                                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                    <span class="text-gray-700">${formatDate(day)}</span>
                                    <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">
                                        ${dayAbsences} ØºÙŠØ§Ø¨
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${uniqueStudents > 0 ? `
                <div class="bg-white border rounded-lg p-4 mb-4">
                    <h6 class="font-bold text-gray-700 mb-3">
                        <i class="fas fa-percentage ml-2"></i>
                        Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
                    </h6>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="p-3">
                            <p class="text-2xl font-bold text-red-600">
                                ${((totalAbsences / filteredData.length) * 100).toFixed(1)}%
                            </p>
                            <p class="text-gray-600 text-sm">Ù†Ø³Ø¨Ø© Ø§Ù„ØºÙŠØ§Ø¨</p>
                        </div>
                        <div class="p-3">
                            <p class="text-2xl font-bold text-green-600">
                                ${((totalParticipations / filteredData.length) * 100).toFixed(1)}%
                            </p>
                            <p class="text-gray-600 text-sm">Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</p>
                        </div>
                        <div class="p-3">
                            <p class="text-2xl font-bold text-blue-600">
                                ${((uniqueStudents - totalAbsences) / uniqueStudents * 100).toFixed(1)}%
                            </p>
                            <p class="text-gray-600 text-sm">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</p>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div class="mt-4 text-sm text-gray-500 flex justify-between items-center">
                    <div>
                        <i class="fas fa-sync-alt ml-1"></i>
                        Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleString('ar-SA')}
                    </div>
                    <button onclick="downloadStatsReport('${course}', '${group}')"
                            class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-sm">
                        <i class="fas fa-download ml-1"></i>ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading stats:', error);
        content.innerHTML = `
            <div class="text-center py-6 text-red-500">
                <i class="fas fa-exclamation-triangle text-2xl mb-3"></i>
                <p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
                <p class="text-sm mt-2">${error.message}</p>
                <button onclick="showGroupSelectionForStats('${course}', ${JSON.stringify(getGroupsForCourse(course))})"
                        class="mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">
                    <i class="fas fa-arrow-right ml-1"></i>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙÙˆØ¬
                </button>
            </div>
        `;
    }
}


// ============================================
// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„ÙØ±ÙŠØ¯Ø©
// ============================================
function getUniqueCourses() {
    return [...new Set(ABSENCES_DATA.schedule.map(row => row['Ø§Ù„Ù…Ù‚ÙŠØ§Ø³']).filter(Boolean))];
}

// ============================================
// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„
// ============================================
// ============================================
// Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
// ============================================
async function fetchCourseAbsences(sheetId, department, course) {
    try {
        const response = await fetch('http://bba1.vercel.app/getCourseAbsences', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sheetId: sheetId,
                department: department,
                course: course
            })
        });
        
        if (!response.ok) throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…');
        
        return await response.json();
    } catch (error) {
        console.error('Error fetching absences:', error);
        throw error;
    }
}

// ============================================
// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
// ============================================
async function onViewCourseChange(course) {
    if (!course) return;
    
    const content = document.getElementById('viewAbsencesContent');
    content.innerHTML = `
        <div class="text-center py-6">
            <div class="spinner mx-auto mb-4"></div>
            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª...</p>
        </div>
    `;
    
    try {
        const session = APP_CONFIG.SESSION;
        
        if (!session || !session.facultySheetId) {
            throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù„Ù„Ø¬Ø¯ÙˆÙ„');
        }
        
        // â­â­ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø®Ø§Ø¯Ù… â­â­
        const result = await fetchCourseAbsencesDirect(
            session.facultySheetId,
            session.department || 'Ø§Ù„Ù‚Ø³Ù…',
            course
        );
        
        if (result.status !== 'success') {
            throw new Error(result.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
        
        const absencesData = result.absences || [];
        
        // ... Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø±Ø¶ (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚)
        displayAbsencesTable(course, absencesData);
        
    } catch (error) {
        console.error('Error loading absences:', error);
        content.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-3xl text-yellow-500 mb-3"></i>
                <h5 class="font-bold text-gray-700 mb-2">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
                <p class="text-gray-600 mb-4">${error.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'}</p>
                <button onclick="onViewCourseChange('${course}')" 
                        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">
                    <i class="fas fa-redo ml-1"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                </button>
            </div>
        `;
    }
}

// ============================================
// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
// ============================================
function displayAbsencesTable(course, absencesData) {
    const content = document.getElementById('viewAbsencesContent');
    
    if (absencesData.length === 0) {
        content.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-check-circle text-3xl text-green-500 mb-3"></i>
                <h5 class="font-bold text-gray-700 mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø©</h5>
                <p class="text-gray-600">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ ØºÙŠØ§Ø¨Ø§Øª Ø£Ùˆ Ù…Ø´Ø§Ø±ÙƒØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</p>
            </div>
        `;
        return;
    }
    
    content.innerHTML = `
        <div>
            <div class="flex justify-between items-center mb-4">
                <h5 class="font-bold text-gray-700">Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª - ${course}</h5>
                <div class="flex space-x-2 space-x-reverse">
                    <button onclick="exportAbsencesToCSV('${course}')" 
                            class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-sm">
                        <i class="fas fa-file-excel ml-1"></i>CSV
                    </button>
                    <button onclick="refreshAbsencesData('${course}')" 
                            class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-sm">
                        <i class="fas fa-redo ml-1"></i>ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto border rounded-lg">
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="p-3 text-right text-gray-600 font-semibold">#</th>
                            <th class="p-3 text-right text-gray-600 font-semibold">Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                            <th class="p-3 text-right text-gray-600 font-semibold">Ø§Ù„Ø§Ø³Ù…</th>
                            <th class="p-3 text-right text-gray-600 font-semibold">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th class="p-3 text-right text-gray-600 font-semibold">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="p-3 text-right text-gray-600 font-semibold">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${absencesData.map((record, index) => `
                            <tr class="border-b hover:bg-gray-50 ${record.isParticipationOnly ? 'bg-blue-50' : ''}">
                                <td class="p-3 text-gray-500">${index + 1}</td>
                                <td class="p-3 font-mono text-blue-600">${record.studentId}</td>
                                <td class="p-3">${record.studentName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                                <td class="p-3">${record.date === 'Ù…Ø´Ø§Ø±ÙƒØ© ÙÙ‚Ø·' ? 
                                    '<span class="text-gray-400">Ù…Ø´Ø§Ø±ÙƒØ© ÙÙ‚Ø·</span>' : 
                                    formatDate(record.date)}</td>
                                <td class="p-3">
                                    <span class="px-2 py-1 rounded text-xs ${record.status === 'ØºØ§Ø¦Ø¨' ? 
                                        'bg-red-100 text-red-800' : 
                                        'bg-green-100 text-green-800'}">
                                        ${record.status === 'ØºØ§Ø¦Ø¨' ? 'ØºÙŠØ§Ø¨' : 'Ø­Ø§Ø¶Ø±'}
                                    </span>
                                </td>
                                <td class="p-3">
                                    ${record.participation ? 
                                        `<span class="px-2 py-1 rounded text-xs ${getParticipationClass(record.participation)}">
                                            ${record.participation}/3
                                        </span>` : 
                                        '<span class="text-gray-400 text-xs">-</span>'
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 flex justify-between items-center text-sm text-gray-500">
                <div>
                    <i class="fas fa-info-circle ml-1"></i>
                    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: <span class="font-bold">${absencesData.length}</span>
                    <span class="mr-4"> | </span>
                    ØºÙŠØ§Ø¨Ø§Øª: <span class="font-bold text-red-600">${absencesData.filter(a => a.status === 'ØºØ§Ø¦Ø¨').length}</span>
                    <span class="mr-2"> | </span>
                    Ù…Ø´Ø§Ø±ÙƒØ§Øª: <span class="font-bold text-blue-600">${absencesData.filter(a => a.participation).length}</span>
                </div>
                <div>
                    <i class="fas fa-sync-alt ml-1"></i>
                    ${new Date().toLocaleTimeString('ar-SA')}
                </div>
            </div>
        </div>
    `;
}

// ============================================
// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
// ============================================
function getParticipationClass(score) {
    if (score === 3) return 'bg-green-100 text-green-800';
    if (score === 2) return 'bg-blue-100 text-blue-800';
    if (score === 1) return 'bg-yellow-100 text-yellow-800';
    return 'bg-gray-100 text-gray-800';
}

async function refreshAbsencesData(course) {
    // Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    if (APP_CONFIG.CACHE.absences) {
        const cacheKey = `absences_${APP_CONFIG.SESSION.facultySheetId}_${APP_CONFIG.SESSION.department}_${course}`;
        delete APP_CONFIG.CACHE.absences[cacheKey];
    }
    
    await onViewCourseChange(course);
    showMessage('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
}

function exportAbsencesToCSV(course) {
    // ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„ØªØµØ¯ÙŠØ± CSV
    showMessage('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...', 'info');
}
// ============================================
// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
// ============================================
// ============================================
// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - Ù†Ø³Ø®Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
// ============================================
async function onStatsCourseChange(course) {
    if (!course) return;
    
    const content = document.getElementById('statsContent');
    content.innerHTML = `
        <div class="text-center py-6">
            <div class="spinner mx-auto mb-4"></div>
            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</p>
        </div>
    `;
    
    try {
        const session = APP_CONFIG.SESSION;
        
        if (!session || !session.facultySheetId) {
            throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù„Ù„Ø¬Ø¯ÙˆÙ„');
        }
        
        // â­â­ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† fetchCourseAbsences â­â­
        const result = await fetchCourseAbsencesDirect(
            session.facultySheetId,
            session.department || 'Ø§Ù„Ù‚Ø³Ù…',
            course
        );
        
        if (result.status !== 'success') {
            throw new Error(result.message || 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
        
        const absencesData = result.absences || [];
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
        const totalAbsences = absencesData.filter(a => a.status === 'ØºØ§Ø¦Ø¨').length;
        const totalParticipations = absencesData.filter(a => a.participation).length;
        const uniqueStudents = [...new Set(absencesData.map(a => a.studentId))].length;
        
        // Ø­Ø³Ø§Ø¨ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
        const participationScores = absencesData
            .filter(a => a.participation)
            .map(a => a.participation);
        
        const participationStats = {
            score1: participationScores.filter(s => s === 1).length,
            score2: participationScores.filter(s => s === 2).length,
            score3: participationScores.filter(s => s === 3).length
        };
        
        content.innerHTML = `
            <div>
                <h5 class="font-bold text-gray-700 mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - ${course}</h5>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-blue-600 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                        <p class="text-2xl font-bold text-blue-800">${uniqueStudents}</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <p class="text-red-600 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª</p>
                        <p class="text-2xl font-bold text-red-800">${totalAbsences}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-green-600 text-sm">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</p>
                        <p class="text-2xl font-bold text-green-800">${totalParticipations}</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-purple-600 text-sm">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</p>
                        <p class="text-2xl font-bold text-purple-800">
                            ${participationScores.length > 0 ? 
                                (participationScores.reduce((a, b) => a + b, 0) / participationScores.length).toFixed(1) : 
                                '0.0'}/3
                        </p>
                    </div>
                </div>
                
                ${totalParticipations > 0 ? `
                <div class="bg-white border rounded-lg p-4 mb-4">
                    <h6 class="font-bold text-gray-700 mb-3">ØªÙˆØ²ÙŠØ¹ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</h6>
                    <div class="space-y-3">
                        ${[
                            {score: 3, label: 'Ù†Ø´ÙŠØ·', color: 'bg-green-500', count: participationStats.score3},
                            {score: 2, label: 'Ù…ØªÙˆØ³Ø·', color: 'bg-blue-500', count: participationStats.score2},
                            {score: 1, label: 'Ø¶Ø¹ÙŠÙ', color: 'bg-yellow-500', count: participationStats.score1}
                        ].map(item => {
                            const percentage = totalParticipations > 0 ? 
                                Math.round((item.count / totalParticipations) * 100) : 0;
                            return `
                                <div class="flex items-center">
                                    <div class="w-24 text-sm text-gray-600">${item.label} (${item.score}/3)</div>
                                    <div class="flex-1 ml-4">
                                        <div class="h-6 bg-gray-200 rounded overflow-hidden">
                                            <div class="h-full ${item.color} transition-all duration-500" 
                                                 style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                    <div class="w-16 text-right text-sm font-medium">${item.count} (${percentage}%)</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${totalAbsences > 0 ? `
                <div class="bg-white border rounded-lg p-4 mb-4">
                    <h6 class="font-bold text-gray-700 mb-3">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª</h6>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">ØºÙŠØ§Ø¨Ø§Øª Ù…Ø¹ Ù…Ø´Ø§Ø±ÙƒØ©</span>
                            <span class="text-sm font-medium">${absencesData.filter(a => a.status === 'ØºØ§Ø¦Ø¨' && a.participation).length}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">ØºÙŠØ§Ø¨Ø§Øª Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§Ø±ÙƒØ©</span>
                            <span class="text-sm font-medium">${absencesData.filter(a => a.status === 'ØºØ§Ø¦Ø¨' && !a.participation).length}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Ø­Ø¶ÙˆØ± Ù…Ø¹ Ù…Ø´Ø§Ø±ÙƒØ©</span>
                            <span class="text-sm font-medium">${absencesData.filter(a => a.status === 'Ø­Ø§Ø¶Ø±' && a.participation).length}</span>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div class="mt-4 text-sm text-gray-500">
                    <i class="fas fa-sync-alt ml-1"></i>
                    Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleString('ar-SA')}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading stats:', error);
        content.innerHTML = `
            <div class="text-center py-6 text-red-500">
                <i class="fas fa-exclamation-triangle text-2xl mb-3"></i>
                <p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
                <p class="text-sm mt-2">${error.message}</p>
                <button onclick="onStatsCourseChange('${course}')" 
                        class="mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">
                    <i class="fas fa-redo ml-1"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                </button>
            </div>
        `;
    }
}

// ============================================
// Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Google Sheets
// ============================================
async function fetchCourseAbsencesDirect(sheetId, department, course, group = null) {
    try {
        // â­â­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø¯ÙŠØ« cacheKey Ù„ØªØ´Ù…Ù„ Ø§Ù„ÙÙˆØ¬
        const cacheKey = `absences_${sheetId}_${department}_${course}${group ? `_${group}` : ''}`;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
        if (APP_CONFIG.CACHE.absences && 
            APP_CONFIG.CACHE.absences[cacheKey] && 
            Date.now() - APP_CONFIG.CACHE.absences[cacheKey].timestamp < 5 * 60 * 1000) {
            console.log(`ğŸ“¦ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù„Ù„Ù…Ù‚ÙŠØ§Ø³: ${course}${group ? ` - Ø§Ù„ÙÙˆØ¬: ${group}` : ''}`);
            return APP_CONFIG.CACHE.absences[cacheKey].data;
        }
        
        console.log(`ğŸŒ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©: ${course}${group ? ` - Ø§Ù„ÙÙˆØ¬: ${group}` : ''}`);
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets API Ù…Ø¨Ø§Ø´Ø±Ø©
        const response = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(department)}`);
        
        if (!response.ok) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${response.status}`);
        }
        
        const text = await response.text();
        const json = JSON.parse(text.substring(47, text.length - 2));
        
        const absencesList = [];
        let headers = [];
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        json.table.rows.forEach((row, index) => {
            const rowData = row.c;
            
            if (index === 0) {
                // Ø­ÙØ¸ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
                headers = rowData.map(cell => cell?.v || '');
            } else if (rowData && rowData.length > 0) {
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙ Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù†
                const rowObject = {};
                rowData.forEach((cell, cellIndex) => {
                    const header = headers[cellIndex];
                    if (header) {
                        rowObject[header] = cell?.v || '';
                    }
                });
                
                // â­â­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙ…Ø±ÙŠØ± group Ù„Ù„Ø¯Ø§Ù„Ø©
                processStudentAbsences(rowObject, course, group, absencesList);
            }
        });
        
        // â­â­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙÙˆØ¬ Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡
        let filteredAbsences = absencesList;
        if (group) {
            filteredAbsences = absencesList.filter(item => {
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙÙˆØ¬ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                return item.group === group || !item.group;
            });
        }
        
        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
        if (!APP_CONFIG.CACHE.absences) {
            APP_CONFIG.CACHE.absences = {};
        }
        APP_CONFIG.CACHE.absences[cacheKey] = {
            data: {
                status: 'success',
                course: course,
                group: group,
                absences: filteredAbsences,
                total: filteredAbsences.length,
                timestamp: new Date().toISOString()
            },
            timestamp: Date.now()
        };
        
        return APP_CONFIG.CACHE.absences[cacheKey].data;
        
    } catch (error) {
        console.error('Error fetching absences directly:', error);
        return {
            status: 'error',
            message: error.message,
            absences: [],
            total: 0
        };
    }
}

// â­â­ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© processStudentAbsences Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙˆØ¬
function processStudentAbsences(studentRow, course, group, absencesList) {
    const studentId = studentRow['Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„'];
    const studentName = studentRow['Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨'];
    const studentGroup = studentRow['Ø§Ù„Ø­ØµØ©'] || studentRow['ÙÙˆØ¬'] || '';
    
    // â­â­ Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ Ø§Ù„ÙÙˆØ¬ Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡
    if (group && studentGroup !== group) {
        return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø£ÙÙˆØ§Ø¬ Ø£Ø®Ø±Ù‰
    }
    
    if (!studentId) return;
    
    // 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØºÙŠØ§Ø¨
    const absenceField = studentRow['Ø§Ù„ØºÙŠØ§Ø¨'] || '{"absences":[]}';
    let absencesJson = { absences: [] };
    
    try {
        absencesJson = JSON.parse(absenceField);
    } catch (error) {
        console.log(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ ${studentId}:`, error.message);
    }
    
    // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
    const participationField = studentRow['Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©'] || '{}';
    let participationData = {};
    
    try {
        participationData = JSON.parse(participationField);
    } catch (error) {
        console.log(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨ ${studentId}:`, error.message);
    }
    
    // 3. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØºÙŠØ§Ø¨Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³
    const courseAbsences = absencesJson.absences.filter(a => a.module === course);
    
    courseAbsences.forEach(absence => {
        absencesList.push({
            studentId,
            studentName,
            date: absence.date,
            course: absence.module,
            status: 'ØºØ§Ø¦Ø¨',
            participation: participationData[course] || null,
            hasParticipation: participationData[course] !== undefined,
            group: studentGroup, // â­ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙˆØ¬
            studentGroup: studentGroup // â­ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        });
    });
    
    // 4. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø¨Ø¯ÙˆÙ† ØºÙŠØ§Ø¨
    if (participationData[course] && courseAbsences.length === 0) {
        absencesList.push({
            studentId,
            studentName,
            date: 'Ù…Ø´Ø§Ø±ÙƒØ© ÙÙ‚Ø·',
            course: course,
            status: 'Ø­Ø§Ø¶Ø±',
            participation: participationData[course],
            hasParticipation: true,
            isParticipationOnly: true,
            group: studentGroup, // â­ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙˆØ¬
            studentGroup: studentGroup // â­ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        });
    }
}
// ============================================
// ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚ÙŠØ§Ø³
// ============================================
async function refreshCourseData(course) {
    await onViewCourseChange(course);
    showMessage('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
}

// ============================================
// Ø¯Ø§Ù„Ø© ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
// ============================================
async function downloadAbsencesReport(course) {
    showMessage('â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„ØªÙ†Ø²ÙŠÙ„...', 'info');
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªØµØ¯ÙŠØ± Excel Ø£Ùˆ PDF Ù„Ø§Ø­Ù‚Ø§Ù‹
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØºÙŠØ§Ø¨Ø§Øª
// ============================================
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

function generateSampleAbsencesData(course) {
    const names = ['Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', 'Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', 'ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡', 'Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†', 'Ø³Ø§Ø±Ø© Ø£Ø­Ù…Ø¯'];
    const dates = ['2024-01-15', '2024-01-22', '2024-01-29', '2024-02-05', '2024-02-12'];
    const statuses = ['ØºÙŠØ§Ø¨', 'Ø­Ø¶ÙˆØ±', 'ØºÙŠØ§Ø¨', 'Ø­Ø¶ÙˆØ±', 'Ø­Ø¶ÙˆØ±'];
    
    return Array.from({ length: 15 }, (_, i) => ({
        id: `2023000${i + 1}`,
        name: names[i % names.length],
        date: dates[i % dates.length],
        status: statuses[i % statuses.length]
    }));
}

function generateSampleStats(course) {
    return {
        totalStudents: 45,
        totalAbsences: 12,
        attendanceRate: 73,
        mostAbsentStudent: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ (4 Ù…Ø±Ø§Øª)',
        distribution: [
            { range: '0 Ù…Ø±Ø©', count: 25, percentage: 56 },
            { range: '1-2 Ù…Ø±Ø©', count: 12, percentage: 27 },
            { range: '3-4 Ù…Ø±Ø©', count: 6, percentage: 13 },
            { range: 'Ø£ÙƒØ«Ø± Ù…Ù† 4', count: 2, percentage: 4 }
        ]
    };
}

function downloadAbsencesReport(course) {
    showMessage(`Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª Ù„Ù€ ${course}`, 'info');
}
        // ============================================
        // ØµÙØ­Ø© ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ (Ø³ÙŠØªÙ… Ø¥ÙƒÙ…Ø§Ù„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
        // ============================================
        async function loadPreferencesPage() {
            const content = document.getElementById('preferencesContent');
            content.innerHTML = `
                <div class="card p-6">
                    <div class="text-center py-12">
                        <div class="w-24 h-24 mx-auto mb-4 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-star text-3xl text-purple-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">â­ ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³</h3>
                        <p class="text-gray-600 mb-6">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                        <div class="space-y-3 max-w-md mx-auto">
                            <button onclick="showPage('dashboard')" 
                                    class="w-full py-3 btn-primary rounded-lg">
                                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // ØµÙØ­Ø© ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù… (Ø³ÙŠØªÙ… Ø¥ÙƒÙ…Ø§Ù„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
        // ============================================
        async function loadDayPreferencesPage() {
            const content = document.getElementById('dayPreferencesContent');
            content.innerHTML = `
                <div class="card p-6">
                    <div class="text-center py-12">
                        <div class="w-24 h-24 mx-auto mb-4 bg-orange-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-calendar-day text-3xl text-orange-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸ—“ï¸ ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù…</h3>
                        <p class="text-gray-600 mb-6">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                        <div class="space-y-3 max-w-md mx-auto">
                            <button onclick="showPage('dashboard')" 
                                    class="w-full py-3 btn-primary rounded-lg">
                                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
        // ============================================
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('ar-SA', options);
            const element = document.getElementById('currentDate');
            if (element) {
                element.textContent = dateString;
            }
        }

        function updateLoadingText(text) {
            const element = document.getElementById('loadingText');
            if (element) element.textContent = text;
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showMessage(message, type = 'info') {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 left-4 z-50 px-4 py-3 rounded-lg shadow-lg ${
                type === 'error' ? 'bg-red-50 border border-red-200 text-red-700' :
                type === 'success' ? 'bg-green-50 border border-green-200 text-green-700' :
                type === 'warning' ? 'bg-yellow-50 border border-yellow-200 text-yellow-700' :
                'bg-blue-50 border border-blue-200 text-blue-700'
            }`;
            
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${
                        type === 'error' ? 'exclamation-circle' :
                        type === 'success' ? 'check-circle' :
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle'
                    } ml-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="mr-auto text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        function showModal(content) {
            const modal = document.getElementById('messageModal');
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = content;
            modal.classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('messageModal').classList.add('hidden');
        }

        function logout() {
            // Ù…Ø³Ø­ Ø§Ù„Ø¬Ù„Ø³Ø©
            localStorage.removeItem('professor_session');
            APP_CONFIG.SESSION = {
                professor: null,
                faculty: null,
                facultySheetId: null,
                semester: null,
                lastLogin: null
            };
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            showPage('login');
            
            showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
        setInterval(updateCurrentDate, 60000);
    </script>
</body>
</html>